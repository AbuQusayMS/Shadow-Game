<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø«Ù‚Ø§ÙØªÙƒ ÙÙŠ Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©.">
    <title>ğŸ§  Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª | Hybrid Edition</title>

    <link rel="icon" type="image/png" href="https://em-content.zobj.net/thumbs/120/apple/354/brain_1f9e0.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Cropper.js for image editing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    
    <!-- JSON-LD for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "VideoGame",
      "name": "ğŸ§  Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
      "description": "Ù„Ø¹Ø¨Ø© Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Web Browser",
      "author": {
        "@type": "Person",
        "name": "MS AbuQusay"
      }
    }
    </script>

    <style>
    :root {
      /* Dark Theme Colors */
      --color-dark-bg: #1a1a2e;
      --color-dark-primary: #16213e;
      --color-dark-secondary: #0f3460;
      --color-dark-accent: #e94560;
      --color-dark-text: #f0f0f0;
      --color-dark-border: #374151;
      --color-dark-gold: #ffd700;
      --color-dark-silver: #c0c0c0;
      --color-dark-bronze: #cd7f32;
      --color-dark-success: #10b981;
      --color-dark-error: #ef4444;

      /* Light Theme Colors */
      --color-light-bg: #f8fafc;
      --color-light-primary: #ffffff;
      --color-light-secondary: #e2e8f0;
      --color-light-accent: #2563eb;
      --color-light-text: #1e293b;
      --color-light-border: #cbd5e1;
      --color-light-gold: #ca8a04;
      --color-light-silver: #a1a1aa;
      --color-light-bronze: #a16207;
      --color-light-success: #059669;
      --color-light-error: #dc2626;

      /* Neutral Colors */
      --color-white: #ffffff;
      --color-black: #000000;
      --color-gray-500: #6b7280;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      /* Typography */
      --font-family: 'Cairo', sans-serif;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.575rem;

      /* Spacing */
      --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem;
      --space-6: 1.5rem; --space-8: 2rem; --space-10: 2.5rem;

      /* Radius */
      --radius-lg: 0.5rem; --radius-xl: 0.75rem; --radius-2xl: 1rem; --radius-full: 9999px;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-normal: 300ms ease;
      
      /* Level Colors */
      --level-easy: #10b981; --level-medium: #3b82f6; --level-hard: #f59e0b; --level-impossible: #ef4444;
    }

    body[data-theme='dark'] {
      --bg-color: var(--color-dark-bg);
      --primary-color: var(--color-dark-primary);
      --secondary-color: var(--color-dark-secondary);
      --accent-color: var(--color-dark-accent);
      --text-color: var(--color-dark-text);
      --border-color: var(--color-dark-border);
      --gold-color: var(--color-dark-gold);
      --silver-color: var(--color-dark-silver);
      --bronze-color: var(--color-dark-bronze);
      --success-color: var(--color-dark-success);
      --error-color: var(--color-dark-error);
    }

    body[data-theme='light'] {
      --bg-color: var(--color-light-bg);
      --primary-color: var(--color-light-primary);
      --secondary-color: var(--color-light-secondary);
      --accent-color: var(--color-light-accent);
      --text-color: var(--color-light-text);
      --border-color: var(--color-light-border);
      --gold-color: var(--color-light-gold);
      --silver-color: var(--color-light-silver);
      --bronze-color: var(--color-light-bronze);
      --success-color: var(--color-light-success);
      --error-color: var(--color-light-error);
    }

    body[data-level="easy"] { --level-color: var(--level-easy); --level-bg: rgba(16, 185, 129, 0.1); }
    body[data-level="medium"] { --level-color: var(--level-medium); --level-bg: rgba(59, 130, 246, 0.1); }
    body[data-level="hard"] { --level-color: var(--level-hard); --level-bg: rgba(245, 158, 11, 0.1); }
    body[data-level="impossible"] { --level-color: var(--level-impossible); --level-bg: rgba(239, 68, 68, 0.1); }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body {
      min-height: 100%;
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
    }
    .screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex;
      flex-direction: column; justify-content: center; align-items: center;
      padding: var(--space-8) var(--space-4); opacity: 0; visibility: hidden;
      transform: scale(0.95); transition: opacity var(--transition-normal), visibility var(--transition-normal), transform var(--transition-normal);
      overflow-y: auto; z-index: 1;
    }
    .screen.screen--align-top { justify-content: flex-start; }
    .screen.active { opacity: 1; visibility: visible; transform: scale(1); z-index: 10; }
    .content-box {
      background-color: var(--primary-color); border-radius: var(--radius-2xl);
      padding: var(--space-6); width: 100%; max-width: 30rem; box-shadow: var(--shadow-xl);
      text-align: center; border: 1px solid var(--border-color); position: relative;
    }
    .screen-header { margin-bottom: var(--space-6); }
    .game-title {
      font-size: var(--font-size-3xl); font-weight: 900; color: var(--gold-color);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    .game-subtitle { color: var(--text-color); opacity: 0.8; margin-top: var(--space-2); font-size: 0.9rem; }
    h2 { font-size: var(--font-size-2xl); font-weight: 700; }
    h3 { font-size: var(--font-size-xl); }
    .button-group { display: flex; flex-direction: column; gap: var(--space-4); margin-top: var(--space-6); }
    .level-selection-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); margin-top: var(--space-6); }
    .btn-main, .btn-secondary {
      padding: var(--space-3) var(--space-6); border-radius: var(--radius-lg); font-weight: 700;
      font-size: var(--font-size-lg); cursor: pointer; transition: all var(--transition-fast);
    }
    .btn-main { background-color: var(--gold-color); color: var(--color-black); border: 2px solid var(--gold-color); box-shadow: var(--shadow-md); }
    .btn-main:hover:not(:disabled) { background-color: transparent; color: var(--gold-color); transform: translateY(-3px); box-shadow: var(--shadow-lg); }
    .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); border: 2px solid var(--border-color); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--accent-color); border-color: var(--accent-color); color: var(--color-white); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
    .form-group { margin-bottom: var(--space-4); text-align: right; }
    .form-group label { display: block; margin-bottom: var(--space-2); font-weight: 600; }
    input[type="text"], input[type="password"], textarea, select {
      width: 100%; padding: var(--space-3); border: 2px solid var(--border-color);
      border-radius: var(--radius-lg); background-color: var(--bg-color); color: var(--text-color);
      font-family: var(--font-family); font-size: var(--font-size-base);
    }
    input[type="text"]:focus, input[type="password"]:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-color); }
    textarea { resize: vertical; min-height: 100px; }
    .error-message { color: var(--error-color); font-size: 0.875rem; margin-top: var(--space-2); display: none; min-height: 1.2em; }
    .error-message.show { display: block; }
    .avatar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6); }
    .avatar-option, .avatar-upload-btn {
      width: 100%; aspect-ratio: 1/1; border-radius: var(--radius-full); object-fit: cover;
      cursor: pointer; border: 3px solid transparent; transition: all var(--transition-fast);
      display: flex; justify-content: center; align-items: center; background-color: var(--secondary-color);
    }
    .avatar-upload-btn { font-size: 2rem; color: var(--text-color); }
    .avatar-option:hover, .avatar-upload-btn:hover { transform: scale(1.05); }
    .avatar-option.selected, .avatar-upload-btn.selected { border-color: var(--gold-color); transform: scale(1.1); }
    .instructions-content { text-align: right; margin: var(--space-6) 0; }
    .instruction-item { display: flex; align-items: flex-start; margin-bottom: var(--space-4); gap: var(--space-3); }
    .instruction-icon { font-size: 1.5rem; flex-shrink: 0; }
    .instructions-content a { color: var(--accent-color); text-decoration: none; font-weight: 700; }
    .instructions-content a:hover { text-decoration: underline; }
    #gameContainer { justify-content: flex-start; padding: var(--space-4); width: 100%; max-width: 900px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); width: 100%; }
    .end-quiz-btn { background-color: var(--error-color); color: var(--color-white); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-2) var(--space-3); cursor: pointer; font-weight: 700; }
    .level-progress { display: flex; gap: var(--space-2); }
    .level-indicator {
      width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: bold; border: 2px solid var(--border-color); background-color: var(--secondary-color); color: var(--text-color); position: relative;
    }
    .level-indicator.active { color: var(--color-white); background-color: var(--level-color); border-color: var(--level-color); }
    .level-indicator[data-tooltip]::after {
      content: attr(data-tooltip); position: absolute; bottom: -2.5rem; left: 50%; transform: translateX(-50%);
      background-color: var(--primary-color); color: var(--text-color); padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-lg); font-size: 0.75rem; white-space: nowrap; opacity: 0; visibility: hidden;
      transition: opacity var(--transition-fast), visibility var(--transition-fast); z-index: 100; border: 1px solid var(--border-color);
    }
    .level-indicator[data-tooltip]:hover::after { opacity: 1; visibility: visible; }
    .theme-toggle-btn { background-color: var(--secondary-color); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-2) var(--space-3); color: var(--text-color); cursor: pointer; }
    .game-header { display: flex; flex-direction: column; padding: var(--space-4); background-color: var(--primary-color); border-radius: var(--radius-xl); width: 100%; gap: var(--space-4); margin-bottom: var(--space-4); box-shadow: var(--shadow-md); }
    .player-info { display: flex; justify-content: space-between; align-items: center; }
    .player-main { display: flex; align-items: center; gap: var(--space-3); }
    #playerAvatar { width: 3.5rem; height: 3.5rem; border-radius: var(--radius-full); border: 2px solid var(--gold-color); object-fit: cover; }
    .player-details { display: flex; flex-direction: column; align-items: flex-start; }
    #playerName { font-size: var(--font-size-lg); font-weight: 700; }
    .player-id { font-size: 0.75rem; opacity: 0.7; }
    .player-stats { display: flex; flex-direction: column; align-items: flex-start; gap: var(--space-1); font-size: 0.875rem; }
    .player-stats strong { color: var(--gold-color); }
    .helpers { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); }
    .helper-btn {
      padding: var(--space-2); background-color: var(--secondary-color); color: var(--text-color); border: 1px solid var(--border-color);
      border-radius: var(--radius-lg); cursor: pointer; transition: all var(--transition-fast); display: flex; flex-direction: column;
      align-items: center; justify-content: center; font-size: 1.1rem;
    }
    .helper-cost { font-size: 0.75rem; font-weight: bold; color: var(--gold-color); margin-top: var(--space-1); }
    .helper-btn:not(:disabled):hover { background-color: var(--accent-color); color: var(--color-white); }
    .timer-container {
      width: 100%; background-color: var(--secondary-color); border-radius: var(--radius-full);
      margin: var(--space-4) 0; position: relative; height: 2rem; min-height: 2rem;
      flex-shrink: 0; overflow: hidden; border: 2px solid var(--border-color);
    }
    .timer-bar { height: 100%; background: linear-gradient(90deg, var(--accent-color), var(--gold-color)); border-radius: var(--radius-full); transition: width 1s linear; width: 100%; }
    .timer-bar.frozen { background: #3b82f6; }
    .timer-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--color-white); font-weight: 700; text-shadow: 1px 1px 2px var(--color-black); }
    .main-content { width: 100%; }
    .question-box { background-color: var(--primary-color); border-radius: var(--radius-xl); padding: var(--space-6); margin-bottom: var(--space-6); box-shadow: var(--shadow-md); text-align: center; position: relative; }
    .level-badge { position: absolute; top: -0.75rem; left: 50%; transform: translateX(-50%); background-color: var(--level-color); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-weight: bold; font-size: 0.875rem; }
    #questionCounter { color: var(--gold-color); font-size: var(--font-size-lg); }
    #questionText { font-size: var(--font-size-xl); font-weight: 600; line-height: 1.5; }
    .options-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-4); }
    .option-btn {
      padding: var(--space-4); background-color: var(--primary-color); border: 2px solid var(--border-color);
      border-radius: var(--radius-xl); color: var(--text-color); font-size: var(--font-size-base);
      font-weight: 700; cursor: pointer; transition: all var(--transition-fast); text-align: center;
    }
    .option-btn:hover:not(.disabled) { background-color: var(--secondary-color); border-color: var(--accent-color); transform: translateY(-2px); }
    .option-btn.correct { background-color: var(--success-color); color: var(--color-white); border-color: var(--success-color); }
    .option-btn.wrong { background-color: var(--error-color); color: var(--color-white); border-color: var(--error-color); }
    .option-btn.disabled { cursor: not-allowed; opacity: 0.5; }
    .option-btn.hidden { visibility: hidden; opacity: 0; }
    .level-stats, .final-stats { text-align: right; margin-bottom: var(--space-6); }
    .level-stats p, .final-stats p { margin-bottom: var(--space-3); font-size: var(--font-size-lg); }
    .level-stats strong, .final-stats strong { color: var(--gold-color); }
    .performance-rating { margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-color); }
    .share-section { margin-top: var(--space-6); border-top: 1px solid var(--border-color); padding-top: var(--space-6); }
    .share-buttons { display: flex; justify-content: center; gap: var(--space-4); margin-top: var(--space-4); }
    .share-btn { border: none; padding: var(--space-3) var(--space-6); border-radius: var(--radius-lg); color: var(--color-white); font-weight: 700; cursor: pointer; font-size: var(--font-size-base); }
    .share-btn.x { background-color: var(--color-black); }
    .share-btn.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7);
      display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0;
      visibility: hidden; transition: all var(--transition-normal);
    }
    .modal.active { opacity: 1; visibility: visible; }
    .modal-content {
      background-color: var(--primary-color); border-radius: var(--radius-2xl); padding: var(--space-6);
      width: 90%; max-width: 30rem; text-align: center; box-shadow: var(--shadow-xl);
      max-height: 90vh; overflow-y: auto;
    }
    .modal-buttons { display: flex; gap: var(--space-4); justify-content: center; margin-top: var(--space-6); }
    .toast-container { position: fixed; top: var(--space-4); left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: var(--space-3); width: 90%; max-width: 30rem; }
    .toast { padding: var(--space-4); border-radius: var(--radius-lg); color: var(--color-white); box-shadow: var(--shadow-lg); animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; width: 100%; text-align: center; }
    .toast.success { background-color: var(--success-color); }
    .toast.error { background-color: var(--error-color); }
    .toast.info { background-color: var(--level-medium); }
    @keyframes toastIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
    .spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--secondary-color); border-top: 4px solid var(--gold-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .report-fab {
      position: fixed; bottom: var(--space-4); left: var(--space-4); width: 3.5rem; height: 3.5rem;
      background-color: var(--gold-color); color: var(--color-black); border-radius: var(--radius-full);
      display: flex; justify-content: center; align-items: center; font-size: 1.5rem;
      box-shadow: var(--shadow-lg); cursor: pointer; z-index: 999; transition: transform var(--transition-fast);
    }
    .report-fab:hover { transform: scale(1.1); }
    .dev-fab {
      position: fixed; bottom: var(--space-4); right: var(--space-4); width: 3.5rem; height: 3.5rem;
      padding: 0.5rem; border-radius: var(--radius-full); display: flex; justify-content: center;
      align-items: center; font-size: 1.5rem; box-shadow: var(--shadow-lg); cursor: pointer; z-index: 1001;
      transition: background-color var(--transition-fast), transform var(--transition-fast); user-select: none;
    }
    .dev-fab:active { transform: scale(1.1); }
    .dev-fab.active { background-color: var(--success-color); color: var(--color-white); }
    .dev-fab.inactive { background-color: var(--color-gray-500); color: var(--color-white); }
    .dev-fab span { pointer-events: none; }
    #image-editor-container { width: 100%; max-width: 400px; height: 300px; margin-bottom: var(--space-4); }
    #image-editor-container img { max-width: 100%; }
    #leaderboardContent { max-height: 60vh; overflow-y: auto; padding: 0 var(--space-2); margin: var(--space-4) 0; }
    .leaderboard-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--space-3); }
    .leaderboard-item { display: flex; align-items: center; padding: var(--space-3); background-color: var(--secondary-color); border-radius: var(--radius-xl); border: 2px solid var(--border-color); transition: all var(--transition-fast); cursor: pointer; }
    .leaderboard-item:hover { transform: scale(1.02); border-color: var(--accent-color); }
    .leaderboard-item.rank-1 { border-color: var(--gold-color); box-shadow: 0 0 10px var(--gold-color); }
    .leaderboard-item.rank-2 { border-color: var(--silver-color); box-shadow: 0 0 8px var(--silver-color); }
    .leaderboard-item.rank-3 { border-color: var(--bronze-color); box-shadow: 0 0 6px var(--bronze-color); }
    .leaderboard-item.impossible-finisher { order: -1; border-color: var(--level-impossible); background: var(--level-bg); }
    .leaderboard-rank { font-size: var(--font-size-xl); font-weight: 900; flex-basis: 3.5rem; flex-shrink: 0; text-align: center; }
    .leaderboard-avatar { width: 3rem; height: 3rem; border-radius: 50%; margin: 0 var(--space-3); object-fit: cover; border: 2px solid var(--border-color); }
    .leaderboard-details { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; gap: var(--space-4); min-width: 0; }
    .leaderboard-name { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .leaderboard-score { font-weight: 700; color: var(--gold-color); font-size: var(--font-size-lg); flex-shrink: 0; }
    .player-details-header { margin-bottom: var(--space-4); display: flex; flex-direction: column; align-items: center; gap: var(--space-2); padding-bottom: var(--space-4); border-bottom: 1px solid var(--border-color); }
    .player-details-avatar { width: 5rem; height: 5rem; border-radius: 50%; border: 3px solid var(--gold-color); }
    .player-details-body { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); text-align: right; }
    .detail-item { display: flex; flex-direction: column; background-color: var(--secondary-color); padding: var(--space-3); border-radius: var(--radius-lg); border: 1px solid var(--border-color); }
    .detail-item.full-width { grid-column: 1 / -1; }
    .detail-item .label { font-size: 0.8rem; opacity: 0.8; margin-bottom: var(--space-1); }
    .detail-item .value { font-size: var(--font-size-lg); font-weight: 700; word-wrap: break-word; }
    .detail-item .value.score { color: var(--gold-color); }
    .progress-bar-container { width: 100%; height: 8px; background-color: var(--border-color); border-radius: var(--radius-full); margin-top: var(--space-2); overflow: hidden; }
    .progress-bar { height: 100%; background-color: var(--success-color); border-radius: var(--radius-full); transition: width var(--transition-normal); }
    @media (min-width: 768px) {
      .screen { padding: var(--space-8); }
      .button-group.start-menu { flex-direction: row; justify-content: center; }
      .game-header { flex-direction: row; justify-content: space-between; align-items: center; }
      .player-info { flex-grow: 1; }
      .player-stats { flex-direction: row; gap: var(--space-6); background: none; padding: 0; }
      .options-grid { grid-template-columns: repeat(2, 1fr); }
    }
    </style>
</head>
<body data-theme="dark" aria-live="polite">
    <div id="toast-container" class="toast-container" aria-live="assertive"></div>
    <div id="reportErrorFab" class="report-fab" role="button" aria-label="Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©">âš ï¸</div>
    <div id="devFloatingBtn" class="dev-fab" role="button" title="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±" style="display: none;"><span>âš¡</span></div>

    <!-- SCREENS -->
    <div id="loader" class="screen active" role="status" aria-label="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„">
        <div class="spinner" aria-hidden="true"></div>
        <p id="loaderText" class="game-subtitle" style="margin-top: 1rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p>
    </div>

    <div id="startScreen" class="screen">
        <div class="content-box">
            <header class="screen-header">
                <h1 class="game-title">ğŸ§  Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h1>
                <p class="game-subtitle">Ø§Ø®ØªØ¨Ø± Ù‚Ø¯Ø±Ø§ØªÙƒ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ø´ÙŠÙ‚Ø©</p>
            </header>
            <div class="button-group">
                <button data-action="showAvatarScreen" class="btn-main">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
                <button data-action="showLeaderboard" class="btn-secondary">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
                <button data-action="showDevPasswordModal" class="btn-secondary">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±</button>
            </div>
        </div>
    </div>
    
    <div id="avatarScreen" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2>Ø§Ø®ØªØ± ØµÙˆØ±ØªÙƒ Ø§Ù„Ø±Ù…Ø²ÙŠØ©</h2></header>
            <div class="avatar-grid" role="group" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ø±Ù…Ø²ÙŠØ©"></div>
            <div class="button-group">
                <button id="confirmAvatarBtn" class="btn-main" disabled data-action="showNameEntryScreen">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>
    </div>

    <div id="nameEntryScreen" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</h2></header>
            <div class="form-group">
                <label for="nameInput" class="sr-only">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</label>
                <input type="text" id="nameInput" placeholder="Ù…Ø«Ù„Ø§: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡" maxlength="25" autocomplete="name" aria-required="true" aria-describedby="nameError">
                <div id="nameError" class="error-message" aria-live="polite"></div>
            </div>
            <div class="button-group">
                <button id="confirmNameBtn" class="btn-main" disabled data-action="confirmName">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø³Ù…</button>
            </div>
        </div>
    </div>
    
    <div id="instructionsScreen" class="screen screen--align-top">
        <div class="content-box">
            <header class="screen-header"><h2>ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2></header>
            <div class="instructions-content">
                <div class="instruction-item"><span class="instruction-icon">âš–ï¸</span><div><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong><br>ØµØ­ÙŠØ­Ø©: +100 / Ø®Ø§Ø·Ø¦Ø©: -100</div></div>
                <div class="instruction-item"><span class="instruction-icon">â±ï¸</span><div><strong>Ø§Ù„ÙˆÙ‚Øª:</strong><br>Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯</div></div>
                <div class="instruction-item"><span class="instruction-icon">ğŸ› ï¸</span><div><strong>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª:</strong><br>50:50/ØªØ¬Ù…ÙŠØ¯: -100 | Ø§Ù„ØªØ®Ø·ÙŠ: -20 (ÙˆØªØªØ²Ø§ÙŠØ¯)</div></div>
                <div class="instruction-item"><span class="instruction-icon">ğŸ¯</span><div><strong>Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª:</strong><br>Ø³Ù‡Ù„ / Ù…ØªÙˆØ³Ø· / ØµØ¹Ø¨ / Ù…Ø³ØªØ­ÙŠÙ„</div></div>
                <div class="instruction-item"><span class="instruction-icon">ğŸš«</span><div><strong>Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</strong><br>Ù…Ø³Ù…ÙˆØ­ 3 ÙÙ‚Ø·</div></div>
                <div class="instruction-item"><span class="instruction-icon">ğŸ“©</span><div><strong>Ø§Ù„Ø¯Ø¹Ù…:</strong><br>ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± <a href="https://x.com/_MS_AbuQusay" target="_blank" rel="noopener noreferrer">X</a> Ø£Ùˆ <a href="https://www.instagram.com/_ms_abuqusay" target="_blank" rel="noopener noreferrer">Instagram</a>.</div></div>
            </div>
            <div class="button-group">
                <button class="btn-main" data-action="postInstructionsStart">Ø­Ø³Ù†Ø§Ù‹ØŒ ÙÙ‡Ù…Øª</button>
            </div>
        </div>
    </div>

    <div id="levelSelectScreen" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2>Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ù„Ù„Ø¨Ø¯Ø¡ (ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±)</h2></header>
            <div class="level-selection-grid">
                <button class="btn-secondary" data-level-index="0" data-action="startDevLevel">Ø³Ù‡Ù„</button>
                <button class="btn-secondary" data-level-index="1" data-action="startDevLevel">Ù…ØªÙˆØ³Ø·</button>
                <button class="btn-secondary" data-level-index="2" data-action="startDevLevel">ØµØ¹Ø¨</button>
                <button class="btn-secondary" data-level-index="3" data-action="startDevLevel">Ù…Ø³ØªØ­ÙŠÙ„</button>
            </div>
        </div>
    </div>

    <main id="gameContainer" class="screen">
        <div class="top-bar">
            <button class="end-quiz-btn" aria-label="Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©" data-action="showConfirmExitModal">ğŸšª Ø¥Ù†Ù‡Ø§Ø¡</button>
            <div class="level-progress">
                <div class="level-indicator" data-level="easy" data-tooltip="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù‡Ù„">1</div>
                <div class="level-indicator" data-level="medium" data-tooltip="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙˆØ³Ø·">2</div>
                <div class="level-indicator" data-level="hard" data-tooltip="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨">3</div>
                <div class="level-indicator" data-level="impossible" data-tooltip="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„">4</div>
            </div>
            <button class="theme-toggle-btn" aria-label="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø·ÙˆØ¹ ÙˆØ§Ù„Ø¸Ù„Ø§Ù…" data-action="toggleTheme">â˜€ï¸</button>
        </div>
        
        <header class="game-header">
            <div class="player-info">
                <div class="player-main">
                    <img id="playerAvatar" src="" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ© Ù„Ù„Ø§Ø¹Ø¨" loading="lazy" decoding="async">
                    <div class="player-details">
                        <span id="playerName" aria-label="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨"></span>
                        <span id="playerId" class="player-id"></span>
                    </div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">Ø§Ù„Ù†Ù‚Ø§Ø·: <strong id="currentScore" aria-live="polite">100</strong></div>
                    <div class="stat-item">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <strong id="wrongAnswersCount" aria-live="assertive">0 / 3</strong></div>
                    <div class="stat-item">Ø§Ù„ØªØ®Ø·ÙŠ: <strong id="skipCount">0</strong></div>
                </div>
            </div>
            <div class="helpers" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©">
                <button class="helper-btn" data-type="fiftyFifty" aria-describedby="fiftyFiftyDesc"><span class="sr-only">Ù…Ø³Ø§Ø¹Ø¯Ø© 50:50</span>50:50<span class="helper-cost">(100)</span></button>
                <button class="helper-btn" data-type="freezeTime" aria-describedby="freezeTimeDesc"><span class="sr-only">Ù…Ø³Ø§Ø¹Ø¯Ø© ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª</span>â„ï¸ 10Ø«<span class="helper-cost">(100)</span></button>
                <button class="helper-btn" data-type="skipQuestion" aria-describedby="skipQuestionDesc"><span class="sr-only">ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„</span>â­ï¸ ØªØ®Ø·ÙŠ<span id="skipCost" class="helper-cost">(20)</span></button>
            </div>
        </header>

        <div class="timer-container" aria-label="Ù…Ø¤Ù‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„">
            <div class="timer-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100"></div>
            <span id="timer" class="timer-text">30</span>
        </div>

        <div class="main-content">
            <section class="question-box" aria-labelledby="questionCounter">
                <div class="level-badge" id="currentLevelBadge">Ø³Ù‡Ù„</div>
                <h3 id="questionCounter">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 5</h3>
                <p id="questionText" aria-live="polite"></p>
            </section>
            <section class="options-container" aria-labelledby="questionText">
                <div class="options-grid" role="group" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©"></div>
            </section>
        </div>
    </main>

    <div id="levelCompleteScreen" class="screen">
        <div class="content-box">
            <header class="screen-header"><h2 id="levelCompleteTitle">ğŸ‰ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰!</h2></header>
            <div class="level-stats">
                <p>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong id="levelScore"></strong></p>
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <strong id="levelErrors"></strong></p>
                <p>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <strong id="levelCorrect"></strong></p>
            </div>
            <div class="button-group">
                <button class="btn-main" data-action="nextLevel">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button class="btn-secondary" data-action="endGame">Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            </div>
        </div>
    </div>

    <div id="endScreen" class="screen screen--align-top">
        <div class="content-box">
            <header class="screen-header"><h2>ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ†</h2></header>
            <div class="final-stats">
                <p>âœï¸ Ø§Ù„Ø§Ø³Ù…: <strong id="finalName"></strong></p>
                <p>ğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: <strong id="finalId"></strong></p>
                <p>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: <strong id="finalAttemptNumber"></strong></p>
                <p>âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: <strong id="finalCorrect"></strong></p>
                <p>âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: <strong id="finalWrong"></strong></p>
                <p>â­ï¸ Ù…Ø±Ø§Øª Ø§Ù„ØªØ®Ø·ÙŠ: <strong id="finalSkips"></strong></p>
                <p>â­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <strong id="finalScore"></strong></p>
                <p>â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: <strong id="totalTime"></strong></p>
                <p>ğŸ“ˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Øª Ø¥Ù„ÙŠÙ‡: <strong id="finalLevel"></strong></p>
                <p>ğŸ¯ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©: <strong id="finalAccuracy"></strong></p>
                <p>â³ Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: <strong id="finalAvgTime"></strong></p>
                <div class="performance-rating"><span>Ø£Ø¯Ø§Ø¤Ùƒ: </span><strong id="performanceText"></strong></div>
            </div>
            <section class="share-section">
                <h3>ğŸ“¢ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                <div class="share-buttons">
                    <button class="share-btn x" data-action="shareOnX">X</button>
                    <button class="share-btn instagram" data-action="shareOnInstagram">Instagram</button>
                </div>
            </section>
            <div class="button-group">
                <button class="btn-main" data-action="playAgain">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
                <button class="btn-secondary" data-action="showLeaderboard">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
            </div>
        </div>
    </div>
    
    <div id="leaderboardScreen" class="screen screen--align-top">
        <div class="content-box">
            <header class="screen-header"><h2>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© ğŸ†</h2></header>
            <div id="leaderboardContent" aria-live="polite"></div>
            <div class="button-group">
                <button class="btn-secondary" data-action="showStartScreen">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="confirmExitModal" class="modal">
        <div class="modal-content">
            <h3>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
            <p>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</p>
            <div class="modal-buttons">
                <button class="btn-main" data-action="endGame">Ù†Ø¹Ù…</button>
                <button class="btn-secondary" data-action="closeModal" data-modal-id="confirmExitModal">Ù„Ø§</button>
            </div>
        </div>
    </div>
    
    <div id="advancedReportModal" class="modal">
        <div class="modal-content">
            <h3>Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</h3>
            <form id="reportProblemForm">
                <div class="form-group">
                    <label for="problemType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</label>
                    <select id="problemType" name="problemType" required>
                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©...</option>
                        <option value="technical">Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ© (ØªØ¬Ù…Ø¯ØŒ Ø¨Ø·Ø¡)</option>
                        <option value="question_error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</option>
                        <option value="account_issue">Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ù†Ù‚Ø§Ø·</option>
                        <option value="suggestion">Ø§Ù‚ØªØ±Ø§Ø­ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©</option>
                        <option value="other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="problemDescription">ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</label>
                    <textarea id="problemDescription" name="problemDescription" placeholder="ÙŠØ±Ø¬Ù‰ ØªÙ‚Ø¯ÙŠÙ… ØªÙØ§ØµÙŠÙ„ Ø¯Ù‚ÙŠÙ‚Ø©..." required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-main">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
                    <button type="button" class="btn-secondary" data-action="closeModal" data-modal-id="advancedReportModal">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="avatarEditorModal" class="modal">
        <div class="modal-content">
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ©</h3>
            <div id="image-editor-container"><img id="image-to-crop" src="" alt="Image for cropping"></div>
            <div class="modal-buttons">
                <button class="btn-main" data-action="saveCroppedAvatar">Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button>
                <button class="btn-secondary" data-action="closeModal" data-modal-id="avatarEditorModal">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="devPasswordModal" class="modal">
        <div class="modal-content">
            <h3>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±</h3>
            <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
            <div class="form-group" style="margin: 1rem 0 0.5rem;">
                <label for="devPasswordInput" class="sr-only">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="devPasswordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" aria-describedby="devPasswordError">
            </div>
            <div id="devPasswordError" class="error-message"></div>
            <div class="modal-buttons">
                <button class="btn-main" data-action="checkDevPassword">Ø¯Ø®ÙˆÙ„</button>
                <button class="btn-secondary" data-action="closeModal" data-modal-id="devPasswordModal">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <div id="playerDetailsModal" class="modal">
        <div class="modal-content">
            <header class="player-details-header">
                <img id="detailsAvatar" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø±Ù…Ø²ÙŠØ©" class="player-details-avatar">
                <h3 id="detailsName"></h3>
                <span id="detailsPlayerId" class="player-id"></span>
            </header>
            <div id="playerDetailsContent" class="player-details-body"></div>
            <div class="modal-buttons">
                <button class="btn-secondary" data-action="closeModal" data-modal-id="playerDetailsModal">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
    class QuizGame {
        constructor() {
            // =================================================================
            // !!!  Game Configuration & Secrets !!!
            // =================================================================
            this.config = {
                // IMPORTANT: Replace with your own Supabase/Apps Script details.
                // Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.
                SUPABASE_URL: 'https://qffcnljopolajeufkrah.supabase.co',
                SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmZmNubGpvcG9sYWpldWZrcmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzkzNjMsImV4cCI6MjA3NDY1NTM2M30.0vst_km_pweyF2IslQ24JzMF281oYeaaeIEQM0aKkUg',
                APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxnkvDR3bVTwlCUtHxT8zwAx5fKhG57xL7dCU1UhuEsMcsktoPRO5FykkLcE7eZwU86dw/exec',
                QUESTIONS_URL: 'https://abuqusayms.github.io/Shadow-Game/questions.json',

                // Developer Settings
                // WARNING: Hardcoding passwords on the client-side is not secure for production.
                // This is for simple project use only.
                DEVELOPER_NAME: "AbuQusay",
                DEVELOPER_PASSWORD: "AbuQusay",

                // Gameplay Settings
                RANDOMIZE_QUESTIONS: true,
                RANDOMIZE_ANSWERS: true,
                QUESTION_TIME: 80,
                MAX_WRONG_ANSWERS: 3,
                STARTING_SCORE: 100,
                
                LEVELS: [
                    { name: "easy", label: "Ø³Ù‡Ù„" },
                    { name: "medium", label: "Ù…ØªÙˆØ³Ø·" },
                    { name: "hard", label: "ØµØ¹Ø¨" },
                    { name: "impossible", label: "Ù…Ø³ØªØ­ÙŠÙ„" }
                ],
                
                HELPER_COSTS: {
                    fiftyFifty: 100,
                    freezeTime: 100,
                    skipQuestionBase: 20,
                    skipQuestionIncrement: 20
                }
            };

            // Internal State
            this.supabase = null;
            this.questions = {};
            this.gameState = {};
            this.timer = { interval: null, isFrozen: false };
            this.dom = {};
            this.cropper = null;
            this.leaderboardSubscription = null;
            this.isDevSession = false;
            this.isDevTemporarilyDisabled = false;

            this.init();
        }

        /**
         * Initializes the game by caching DOM elements, binding events,
         * connecting to services, and loading questions.
         */
        async init() {
            this.cacheDomElements();
            this.bindEventListeners();
            this.populateAvatarGrid();

            try {
                this.supabase = supabase.createClient(this.config.SUPABASE_URL, this.config.SUPABASE_KEY);
                if (!this.supabase) throw new Error("Supabase client failed to initialize.");
            } catch (error) {
                console.error("Error initializing Supabase:", error);
                this.showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
                document.getElementById('loaderText').textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….";
                return;
            }
            
            const questionsLoaded = await this.loadQuestions();
            
            if (questionsLoaded) {
                this.showScreen('start');
            } else {
                document.getElementById('loaderText').textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.";
            }
            this.dom.screens.loader.classList.remove('active');
        }

        /**
         * Caches frequently accessed DOM elements for performance.
         */
        cacheDomElements() {
            const byId = (id) => document.getElementById(id);
            this.dom = {
                screens: {
                    loader: byId('loader'), start: byId('startScreen'), avatar: byId('avatarScreen'),
                    nameEntry: byId('nameEntryScreen'), instructions: byId('instructionsScreen'),
                    levelSelect: byId('levelSelectScreen'), game: byId('gameContainer'),
                    levelComplete: byId('levelCompleteScreen'), end: byId('endScreen'), leaderboard: byId('leaderboardScreen')
                },
                modals: {
                    confirmExit: byId('confirmExitModal'), advancedReport: byId('advancedReportModal'),
                    avatarEditor: byId('avatarEditorModal'), devPassword: byId('devPasswordModal'),
                    playerDetails: byId('playerDetailsModal')
                },
                nameInput: byId('nameInput'),
                nameError: byId('nameError'),
                confirmNameBtn: byId('confirmNameBtn'),
                confirmAvatarBtn: byId('confirmAvatarBtn'),
                reportProblemForm: byId('reportProblemForm'),
                imageToCrop: byId('image-to-crop'),
                devPasswordInput: byId('devPasswordInput'),
                devPasswordError: byId('devPasswordError'),
                devFloatingBtn: byId('devFloatingBtn'),
                leaderboardContent: byId('leaderboardContent'),
                questionText: byId('questionText'),
                optionsGrid: this.getEl('.options-grid'),
                scoreDisplay: byId('currentScore')
            };
        }
        
        getEl(selector, parent = document) { return parent.querySelector(selector); }
        getAllEl(selector, parent = document) { return parent.querySelectorAll(selector); }

        /**
         * Sets up event listeners, primarily using event delegation for efficiency.
         */
        bindEventListeners() {
            // Event delegation for all main actions
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const action = target.dataset.action;
                const actionHandlers = {
                    showAvatarScreen: () => this.showScreen('avatar'),
                    showNameEntryScreen: () => this.showScreen('nameEntry'),
                    confirmName: () => this.handleNameConfirmation(),
                    postInstructionsStart: () => this.postInstructionsStart(),
                    showLeaderboard: () => this.displayLeaderboard(),
                    showStartScreen: () => this.showScreen('start'),
                    toggleTheme: () => this.toggleTheme(),
                    showConfirmExitModal: () => this.showModal('confirmExit'),
                    showDevPasswordModal: () => this.showModal('devPassword'),
                    closeModal: () => this.hideModal(target.dataset.modalId),
                    endGame: () => this.endGame(),
                    nextLevel: () => this.nextLevel(),
                    playAgain: () => window.location.reload(),
                    shareOnX: () => this.shareOnX(),
                    shareOnInstagram: () => this.shareOnInstagram(),
                    saveCroppedAvatar: () => this.saveCroppedAvatar(),
                    checkDevPassword: () => this.checkDevPassword(),
                    startDevLevel: () => this.startGameFlow(parseInt(target.dataset.levelIndex, 10))
                };
                
                if (actionHandlers[action]) actionHandlers[action]();
            });

            // Specific listeners for inputs and forms
            this.dom.nameInput.addEventListener('input', () => this.validateNameInput());
            this.dom.nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.handleNameConfirmation(); });
            this.dom.devPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.checkDevPassword(); });
            this.dom.reportProblemForm.addEventListener('submit', (e) => this.handleReportSubmit(e));
            this.getEl('.avatar-grid').addEventListener('click', (e) => {
                if (e.target.matches('.avatar-option')) this.selectAvatar(e.target);
            });
            this.dom.optionsGrid.addEventListener('click', e => {
                const btn = e.target.closest('.option-btn');
                if (btn) this.checkAnswer(btn);
            });
            this.getEl('.helpers').addEventListener('click', e => {
                const btn = e.target.closest('.helper-btn');
                if (btn) this.useHelper(btn);
            })
        }

        // =============================================
        // Game Flow & State Management
        // =============================================

        /**
         * Transitions from instructions to the game or level selection.
         */
        postInstructionsStart() {
            this.setupInitialGameState();
            if (this.isDevSession) {
                this.showScreen('levelSelect');
            } else {
                this.startGameFlow(0); // Start from level 0 (easy)
            }
        }
        
        /**
         * Initializes the game state object at the start of a new game.
         */
        setupInitialGameState() {
            this.gameState = {
                name: this.dom.nameInput.value.trim(),
                avatar: this.gameState.avatar, // Persist avatar selection
                playerId: `PL${Math.random().toString(36).substring(2, 11).toUpperCase()}`,
                deviceId: this.getOrSetDeviceId(),
                level: 0,
                questionIndex: 0,
                wrongAnswers: 0,
                correctAnswers: 0,
                skips: 0,
                startTime: new Date(),
                helpersUsed: { fiftyFifty: false, freezeTime: false },
                currentScore: this.config.STARTING_SCORE
            };
        }

        /**
         * Starts the main game loop from a specific level.
         * @param {number} levelIndex - The index of the level to start.
         */
        startGameFlow(levelIndex = 0) {
            this.gameState.level = levelIndex;
            this.updateScore(this.config.STARTING_SCORE, true);
            this.setupGameUI();
            this.showScreen('game');
            this.startLevel();
        }
        
        /**
         * Prepares and starts a new level.
         */
        startLevel() {
            const currentLevel = this.config.LEVELS[this.gameState.level];
            document.body.dataset.level = currentLevel.name;
            this.getEl('#currentLevelBadge').textContent = currentLevel.label;
            
            let levelQuestions = [...this.questions[currentLevel.name]];
            if (this.config.RANDOMIZE_QUESTIONS) this.shuffleArray(levelQuestions);
            this.gameState.shuffledQuestions = levelQuestions;

            this.updateLevelProgressUI();
            this.gameState.questionIndex = 0;
            this.fetchQuestion();
        }

        /**
         * Fetches and displays the next question in the current level.
         */
        fetchQuestion() {
            const questions = this.gameState.shuffledQuestions;
            if (this.gameState.questionIndex >= questions.length) {
                this.levelComplete();
                return;
            }
            const questionData = questions[this.gameState.questionIndex];
            this.displayQuestion(questionData);
        }

        /**
         * Handles the end of a level, transitioning to the next or ending the game.
         */
        levelComplete() {
            const isLastLevel = this.gameState.level >= this.config.LEVELS.length - 1;
            if (isLastLevel) {
                this.endGame(true); // Game won
                return;
            }
            
            this.getEl('#levelCompleteTitle').textContent = `ğŸ‰ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${this.config.LEVELS[this.gameState.level].label}!`;
            this.getEl('#levelScore').textContent = this.formatNumber(this.gameState.currentScore);
            this.getEl('#levelErrors').textContent = this.gameState.wrongAnswers;
            this.getEl('#levelCorrect').textContent = this.gameState.correctAnswers;
            this.showScreen('levelComplete');
        }

        /**
         * Proceeds to the next level.
         */
        nextLevel() {
            this.gameState.level++;
            if (this.gameState.level >= this.config.LEVELS.length) {
                this.endGame(true);
            } else {
                this.showScreen('game');
                this.startLevel();
            }
        }
        
        /**
         * Ends the game, calculates final stats, and saves the results.
         * @param {boolean} [completedAllLevels=false] - Whether the player finished the entire game.
         */
        async endGame(completedAllLevels = false) {
            clearInterval(this.timer.interval);
            this.hideModal('confirmExit');

            const finalStats = this._calculateFinalStats(completedAllLevels);
            
            if (!this.isDevSession) {
                const { attemptNumber, error } = await this.saveResultsToSupabase(finalStats);
                if (error) {
                    this.showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±", "error");
                }
                finalStats.attempt_number = attemptNumber ?? 'N/A';
            } else {
                finalStats.attempt_number = 'DEV';
            }
            
            this._displayFinalStats(finalStats);
            this.showScreen('end');
        }

        /**
         * Calculates all final statistics for the end screen and database.
         * @param {boolean} completedAll - True if all levels were beaten.
         * @returns {object} The final stats object.
         */
        _calculateFinalStats(completedAll) {
            const totalTimeSeconds = (new Date() - this.gameState.startTime) / 1000;
            const currentLevelLabel = this.config.LEVELS[Math.min(this.gameState.level, this.config.LEVELS.length - 1)].label;
            const totalAnswered = this.gameState.correctAnswers + this.gameState.wrongAnswers;
            const accuracy = totalAnswered > 0 ? parseFloat(((this.gameState.correctAnswers / totalAnswered) * 100).toFixed(1)) : 0.0;
            const avgTime = totalAnswered > 0 ? parseFloat((totalTimeSeconds / totalAnswered).toFixed(1)) : 0.0;

            return {
                name: this.gameState.name,
                player_id: this.gameState.playerId,
                device_id: this.gameState.deviceId,
                avatar: this.gameState.avatar,
                correct_answers: this.gameState.correctAnswers,
                wrong_answers: this.gameState.wrongAnswers,
                skips: this.gameState.skips,
                score: this.gameState.currentScore,
                total_time: totalTimeSeconds,
                level: currentLevelLabel,
                accuracy: accuracy,
                avg_time: avgTime,
                performance_rating: this.getPerformanceRating(accuracy),
                completed_all: completedAll,
                used_fifty_fifty: this.gameState.helpersUsed.fiftyFifty,
                used_freeze_time: this.gameState.helpersUsed.freezeTime
            };
        }

        // =============================================
        // UI & Display Logic
        // =============================================

        /**
         * Renders a question and its options on the screen.
         * @param {object} questionData - The question object from questions.json.
         */
        displayQuestion(questionData) {
            this.answerSubmitted = false;
            
            const correctAnswerText = questionData.options[questionData.correct];
            let options = [...questionData.options];
            if (this.config.RANDOMIZE_ANSWERS) this.shuffleArray(options);

            const totalQuestions = this.gameState.shuffledQuestions.length;
            this.getEl('#questionCounter').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${this.gameState.questionIndex + 1} Ù…Ù† ${totalQuestions}`;
            this.dom.questionText.textContent = questionData.q;
            this.dom.optionsGrid.innerHTML = ''; // Clear previous options

            const fragment = document.createDocumentFragment();
            options.forEach(optionText => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = optionText;
                button.dataset.correct = (optionText === correctAnswerText);
                fragment.appendChild(button);
            });
            this.dom.optionsGrid.appendChild(fragment);

            this.updateGameStatsUI();
            this.startTimer();
        }

        /**
         * Handles the player's answer selection.
         * @param {HTMLElement} selectedButton - The button element that was clicked.
         */
        checkAnswer(selectedButton) {
            if (this.answerSubmitted) return;
            this.answerSubmitted = true;
            clearInterval(this.timer.interval);
            this.getAllEl('.option-btn').forEach(b => b.classList.add('disabled'));

            const isCorrect = selectedButton.dataset.correct === 'true';

            if (isCorrect) {
                selectedButton.classList.add('correct');
                this.updateScore(this.gameState.currentScore + 100);
                this.gameState.correctAnswers++;
                this.showToast("Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! +100 Ù†Ù‚Ø·Ø©", "success");
            } else {
                selectedButton.classList.add('wrong');
                const correctButton = this.dom.optionsGrid.querySelector('[data-correct="true"]');
                if (correctButton) correctButton.classList.add('correct');
                this.gameState.wrongAnswers++;
                this.updateScore(this.gameState.currentScore - 100);
                this.showToast("Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! -100 Ù†Ù‚Ø·Ø©", "error");
            }

            this.gameState.questionIndex++;
            this.updateGameStatsUI();

            const isGameOver = this.gameState.wrongAnswers >= this.config.MAX_WRONG_ANSWERS && !this.isDeveloper();
            
            setTimeout(() => {
                if (isGameOver) this.endGame(false);
                else this.fetchQuestion();
            }, 2000);
        }
        
        /**
         * Updates all dynamic UI elements during gameplay.
         */
        updateGameStatsUI() {
            this.getEl('#wrongAnswersCount').textContent = `${this.gameState.wrongAnswers} / ${this.config.MAX_WRONG_ANSWERS}`;
            this.getEl('#skipCount').textContent = this.gameState.skips;

            const skipCost = this.config.HELPER_COSTS.skipQuestionBase + (this.gameState.skips * this.config.HELPER_COSTS.skipQuestionIncrement);
            this.getEl('#skipCost').textContent = `(${skipCost})`;
            
            const isImpossible = this.config.LEVELS[this.gameState.level]?.name === 'impossible';
            this.getAllEl('.helper-btn').forEach(btn => {
                const type = btn.dataset.type;
                if (this.isDeveloper()) {
                    btn.disabled = false;
                    return;
                }
                btn.disabled = isImpossible || (type !== 'skipQuestion' && this.gameState.helpersUsed[type]);
            });
        }
        
        /**
         * Displays the final stats on the end screen.
         * @param {object} stats - The final stats object.
         */
        _displayFinalStats(stats) {
            this.getEl('#finalName').textContent = stats.name;
            this.getEl('#finalId').textContent = stats.player_id;
            this.getEl('#finalAttemptNumber').textContent = stats.attempt_number;
            this.getEl('#finalCorrect').textContent = stats.correct_answers;
            this.getEl('#finalWrong').textContent = stats.wrong_answers;
            this.getEl('#finalSkips').textContent = stats.skips;
            this.getEl('#finalScore').textContent = this.formatNumber(stats.score);
            this.getEl('#totalTime').textContent = this.formatTime(stats.total_time);
            this.getEl('#finalLevel').textContent = stats.level;
            this.getEl('#finalAccuracy').textContent = `${stats.accuracy}%`;
            this.getEl('#finalAvgTime').textContent = `${this.formatTime(stats.avg_time)} / Ø³Ø¤Ø§Ù„`;
            this.getEl('#performanceText').textContent = stats.performance_rating;
        }

        // =============================================
        // Data & API Handling
        // =============================================

        async loadQuestions() {
            try {
                const response = await fetch(this.config.QUESTIONS_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                this.questions = await response.json();
                return true;
            } catch (error) {
                console.error("Failed to load questions file:", error);
                return false;
            }
        }
        
        async saveResultsToSupabase(resultsData) {
            try {
                const { count, error: countError } = await this.supabase
                    .from('log')
                    .select('id', { count: 'exact', head: true })
                    .eq('device_id', resultsData.device_id);

                if (countError) throw countError;
                const attemptNumber = (count || 0) + 1;
                
                const { error: logError } = await this.supabase.from('log').insert({ ...resultsData, attempt_number: attemptNumber });
                if (logError) throw logError;
                
                const leaderboardData = {
                    device_id: resultsData.device_id,
                    player_id: resultsData.player_id,
                    name: resultsData.name, avatar: resultsData.avatar, score: resultsData.score,
                    level: resultsData.level, accuracy: resultsData.accuracy, total_time: resultsData.total_time,
                    avg_time: resultsData.avg_time, correct_answers: resultsData.correct_answers,
                    wrong_answers: resultsData.wrong_answers, skips: resultsData.skips,
                    attempt_number: attemptNumber, performance_rating: resultsData.performance_rating,
                    is_impossible_finisher: resultsData.completed_all && resultsData.level === 'Ù…Ø³ØªØ­ÙŠÙ„'
                };
                const { error: leaderboardError } = await this.supabase.from('leaderboard').upsert(leaderboardData);
                if (leaderboardError) throw leaderboardError;
                
                this.showToast("ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!", "success");
                this.sendTelegramNotification('gameResult', { ...resultsData, attempt_number: attemptNumber });
                return { attemptNumber, error: null };

            } catch (error) {
                console.error("Failed to send results to Supabase:", error);
                return { attemptNumber: null, error: error.message };
            }
        }
        
        async handleReportSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const reportData = {
                type: formData.get('problemType'),
                description: formData.get('problemDescription'),
                name: this.gameState.name || 'Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨',
                player_id: this.gameState.playerId || 'N/A',
                question_text: this.dom.questionText.textContent || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'
            };

            this.showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº...", "info");
            this.hideModal('advancedReport');

            try {
                const { error } = await this.supabase.from('reports').insert(reportData);
                if (error) throw error;
                this.showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§ØºÙƒ Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!", "success");
                this.sendTelegramNotification('report', reportData);
            } catch (error) {
                console.error("Supabase report error:", error);
                this.showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº.", "error");
            }
        }
        
        async sendTelegramNotification(type, data) {
            if (!this.config.APPS_SCRIPT_URL) {
                console.warn("Apps Script URL is not configured. Skipping notification.");
                return;
            }
            try {
                await fetch(this.config.APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' }, // Use text/plain for no-cors
                    body: JSON.stringify({ type, data })
                });
            } catch (error) {
                console.error('Error sending notification request to Apps Script:', error.message);
            }
        }
        
        // ... (Other helper methods like useHelper, startTimer, updateScore, etc. would go here)
        useHelper(btn) {
            const type = btn.dataset.type;
            const isDev = this.isDeveloper();
            const cost = type === 'skipQuestion' 
                ? this.config.HELPER_COSTS.skipQuestionBase + (this.gameState.skips * this.config.HELPER_COSTS.skipQuestionIncrement)
                : this.config.HELPER_COSTS[type];

            if (!isDev && this.gameState.currentScore < cost) {
                this.showToast("Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ©!", "error");
                return;
            }

            if (!isDev) {
                this.updateScore(this.gameState.currentScore - cost);
                this.showToast(`ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©! -${cost} Ù†Ù‚Ø·Ø©`, "info");
            } else {
                this.showToast(`Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø·ÙˆØ± (${type})`, "info");
            }

            if (type === 'skipQuestion') {
                clearInterval(this.timer.interval);
                this.gameState.skips++;
                this.gameState.questionIndex++;
                this.updateGameStatsUI();
                this.fetchQuestion();
            } else {
                if (!isDev) this.gameState.helpersUsed[type] = true;
                this.updateGameStatsUI();
                if (type === 'fiftyFifty') {
                    const wrongOptions = this.getAllEl('.option-btn:not([data-correct="true"])');
                    this.shuffleArray(Array.from(wrongOptions)).slice(0, 2).forEach(btn => btn.classList.add('hidden'));
                } else if (type === 'freezeTime') {
                    this.timer.isFrozen = true;
                    this.getEl('.timer-bar').classList.add('frozen');
                    setTimeout(() => {
                        this.timer.isFrozen = false;
                        this.getEl('.timer-bar').classList.remove('frozen');
                    }, 10000);
                }
            }
        }

        startTimer() {
            clearInterval(this.timer.interval);
            let timeLeft = this.config.QUESTION_TIME;
            const timerBar = this.getEl('.timer-bar');
            const timerDisplay = this.getEl('.timer-text');
            timerDisplay.textContent = timeLeft;
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            // Force reflow to restart animation
            void timerBar.offsetWidth;
            timerBar.style.transition = `width ${this.config.QUESTION_TIME}s linear`;
            timerBar.style.width = '0%';

            this.timer.interval = setInterval(() => {
                if (this.timer.isFrozen) return;
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(this.timer.interval);
                    this.showToast("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!", "error");
                    this.checkAnswer({ dataset: { correct: 'false' } }); // Simulate wrong answer
                }
            }, 1000);
        }
        
        updateScore(newScore, isReset = false) {
            this.gameState.currentScore = (this.isDeveloper() && !isReset) ? this.gameState.currentScore : newScore;
            this.dom.scoreDisplay.textContent = this.formatNumber(this.gameState.currentScore);
            this.updateGameStatsUI();
        }

        // =============================================
        // Utility & Helper Functions
        // =============================================

        shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        getOrSetDeviceId() {
            let deviceId = localStorage.getItem('quizGameDeviceId');
            if (!deviceId) {
                deviceId = 'D' + Date.now().toString(36) + Math.random().toString(36).substring(2, 11).toUpperCase();
                localStorage.setItem('quizGameDeviceId', deviceId);
            }
            return deviceId;
        }

        isDeveloper() { return this.isDevSession && !this.isDevTemporarilyDisabled; }
        
        getPerformanceRating(accuracy) {
            if (accuracy >= 90) return "Ù…Ù…ØªØ§Ø² ğŸ†";
            if (accuracy >= 75) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ â­";
            if (accuracy >= 60) return "Ø¬ÙŠØ¯ ğŸ‘";
            if (accuracy >= 40) return "Ù…Ù‚Ø¨ÙˆÙ„ ğŸ‘Œ";
            return "ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ğŸ“ˆ";
        }
        
        formatTime(totalSeconds) {
            const total = Math.floor(totalSeconds);
            const minutes = Math.floor(total / 60);
            const seconds = total % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        formatNumber(num) { return new Intl.NumberFormat('ar-EG').format(num); }

        // ... (All other methods for UI, modals, dev mode, sharing, leaderboard, etc.)
                
        // =============================================
        // Dev Mode
        // =============================================
        checkDevPassword() {
            const input = this.dom.devPasswordInput.value;
            if (input.toLowerCase() === this.config.DEVELOPER_PASSWORD.toLowerCase()) {
                this.activateDevSession();
            } else {
                this.dom.devPasswordError.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                this.dom.devPasswordError.classList.add('show');
            }
        }
        
        activateDevSession(fromModal = true) {
            this.isDevSession = true;
            if (fromModal) this.hideModal('devPassword');
            this.showToast("ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±", "success");
            const fab = this.dom.devFloatingBtn;
            fab.style.display = 'flex';
            fab.classList.add('active');
            fab.classList.remove('inactive');
            fab.querySelector('span').innerHTML = 'âš¡';
        }

        // =============================================
        // UI Helpers (Screens, Modals, Toasts, etc.)
        // =============================================

        showScreen(screenName) {
            Object.values(this.dom.screens).forEach(screen => screen.classList.remove('active'));
            if (this.dom.screens[screenName]) this.dom.screens[screenName].classList.add('active');
        }

        showModal(modalName) { this.dom.modals[modalName].classList.add('active'); }
        hideModal(modalName) { this.dom.modals[modalName].classList.remove('active'); }

        showToast(message, type = 'info') {
            const toastContainer = this.getEl('#toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        toggleTheme() {
            const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = newTheme;
            localStorage.setItem('theme', newTheme);
            this.getEl('.theme-toggle-btn').textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        
        updateLevelProgressUI() {
            this.getAllEl('.level-indicator').forEach((indicator, index) => {
                indicator.classList.toggle('active', index === this.gameState.level);
                indicator.classList.toggle('completed', index < this.gameState.level);
            });
        }
        
        handleNameConfirmation() {
            if (!this.dom.confirmNameBtn.disabled) {
                if (this.dom.nameInput.value.trim().toLowerCase() === this.config.DEVELOPER_NAME.toLowerCase()) {
                    this.activateDevSession(false);
                }
                this.showScreen('instructions');
            }
        }
        
        validateNameInput() {
            const name = this.dom.nameInput.value.trim();
            const isValid = name.length >= 3;
            this.dom.nameError.textContent = isValid ? "" : "Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† Ù£ Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
            this.dom.nameError.classList.toggle('show', !isValid);
            this.dom.confirmNameBtn.disabled = !isValid;
        }

        // ... Leaderboard, Avatar, Sharing methods
                
        // =============================================
        // Leaderboard
        // =============================================

        async displayLeaderboard() {
            this.showScreen('leaderboard');
            this.dom.leaderboardContent.innerHTML = '<div class="spinner"></div>';

            try {
                const { data: players, error } = await this.supabase
                    .from('leaderboard')
                    .select('*')
                    .order('is_impossible_finisher', { ascending: false })
                    .order('score', { ascending: false })
                    .order('accuracy', { ascending: false })
                    .order('total_time', { ascending: true })
                    .limit(100);

                if (error) throw error;
                this.renderLeaderboard(players);
                this.subscribeToLeaderboardChanges();
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                this.dom.leaderboardContent.innerHTML = '<p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©.</p>';
            }
        }

        renderLeaderboard(players) {
            if (players.length === 0) {
                this.dom.leaderboardContent.innerHTML = '<p>Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠÙ‹Ø§!</p>';
                return;
            }
            const list = document.createElement('ul');
            list.className = 'leaderboard-list';
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            let rankCounter = 1;

            players.forEach(player => {
                const item = document.createElement('li');
                item.className = 'leaderboard-item';
                let rankDisplay;

                if (player.is_impossible_finisher) {
                    item.classList.add('impossible-finisher');
                    rankDisplay = 'ğŸ–ï¸';
                } else {
                    if (rankCounter <= 3) {
                        item.classList.add(`rank-${rankCounter}`);
                        rankDisplay = medals[rankCounter - 1];
                    } else {
                        rankDisplay = rankCounter;
                    }
                    rankCounter++;
                }

                item.innerHTML = `
                    <span class="leaderboard-rank">${rankDisplay}</span>
                    <img src="${player.avatar || ''}" alt="ØµÙˆØ±Ø© ${player.name}" class="leaderboard-avatar" loading="lazy" style="visibility: ${player.avatar ? 'visible' : 'hidden'}">
                    <div class="leaderboard-details">
                        <span class="leaderboard-name">${player.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                        <span class="leaderboard-score">${this.formatNumber(player.score)}</span>
                    </div>`;
                item.addEventListener('click', () => this.showPlayerDetails(player));
                list.appendChild(item);
            });
            this.dom.leaderboardContent.innerHTML = '';
            this.dom.leaderboardContent.appendChild(list);
        }
        
        subscribeToLeaderboardChanges() {
            if (this.leaderboardSubscription) this.leaderboardSubscription.unsubscribe();
            
            this.leaderboardSubscription = this.supabase
                .channel('public:leaderboard')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'leaderboard' }, () => this.displayLeaderboard())
                .subscribe();
        }

        showPlayerDetails(player) {
            this.getEl('#detailsName').textContent = player.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            this.getEl('#detailsPlayerId').textContent = player.player_id || 'N/A';
            const avatar = this.getEl('#detailsAvatar');
            avatar.src = player.avatar || '';
            avatar.style.visibility = player.avatar ? 'visible' : 'hidden';

            this.getEl('#playerDetailsContent').innerHTML = `
                <div class="detail-item"><span class="label">â­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</span><span class="value score">${this.formatNumber(player.score || 0)}</span></div>
                <div class="detail-item"><span class="label">ğŸ‘‘ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span class="value">${player.level || 'N/A'}</span></div>
                <div class="detail-item"><span class="label">âœ… Ø§Ù„ØµØ­ÙŠØ­Ø©</span><span class="value">${this.formatNumber(player.correct_answers || 0)}</span></div>
                <div class="detail-item"><span class="label">âŒ Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</span><span class="value">${this.formatNumber(player.wrong_answers || 0)}</span></div>
                <div class="detail-item"><span class="label">â±ï¸ Ø§Ù„ÙˆÙ‚Øª</span><span class="value">${this.formatTime(player.total_time || 0)}</span></div>
                <div class="detail-item"><span class="label">â³ Ø§Ù„Ù…ØªÙˆØ³Ø·</span><span class="value">${this.formatTime(player.avg_time || 0)}/Ø³</span></div>
                <div class="detail-item full-width">
                    <span class="label">ğŸ¯ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©</span><span class="value">${player.accuracy || 0}%</span>
                    <div class="progress-bar-container"><div class="progress-bar" style="width: ${player.accuracy || 0}%;"></div></div>
                </div>
                <div class="detail-item"><span class="label">â­ï¸ Ø§Ù„ØªØ®Ø·ÙŠ</span><span class="value">${this.formatNumber(player.skips || 0)}</span></div>
                <div class="detail-item"><span class="label">ğŸ”¢ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</span><span class="value">${this.formatNumber(player.attempt_number || 0)}</span></div>
                <div class="detail-item full-width"><span class="label">ğŸ“Š Ø§Ù„Ø£Ø¯Ø§Ø¡</span><span class="value">${player.performance_rating || 'Ø¬ÙŠØ¯'}</span></div>
            `;
            this.showModal('playerDetails');
        }

        // =============================================
        // Avatar Handling
        // =============================================

        populateAvatarGrid() {
            const grid = this.getEl('.avatar-grid');
            grid.innerHTML = '';
            const uploadBtnHTML = `<div class="avatar-upload-btn" title="Ø±ÙØ¹ ØµÙˆØ±Ø©"><span aria-hidden="true">+</span><label for="avatarUploadInput" class="sr-only">Ø±ÙØ¹ ØµÙˆØ±Ø©</label><input type="file" id="avatarUploadInput" accept="image/*" style="display:none;"></div>`;
            grid.insertAdjacentHTML('beforeend', uploadBtnHTML);

            this.getEl('#avatarUploadInput').addEventListener('change', e => this.handleAvatarUpload(e));
            this.getEl('.avatar-upload-btn').addEventListener('click', () => this.getEl('#avatarUploadInput').click());

            const avatarUrls = [ "https://em-content.zobj.net/thumbs/120/apple/354/woman_1f469.png", "https://em-content.zobj.net/thumbs/120/apple/354/man_1f468.png", "https://em-content.zobj.net/thumbs/120/apple/354/person-beard_1f9d4.png", "https://em-content.zobj.net/thumbs/120/apple/354/old-man_1f474.png", "https://em-content.zobj.net/thumbs/120/apple/354/student_1f9d1-200d-1f393.png", "https://em-content.zobj.net/thumbs/120/apple/354/teacher_1f9d1-200d-1f3eb.png", "https://em-content.zobj.net/thumbs/120/apple/354/scientist_1f9d1-200d-1f52c.png", "https://em-content.zobj.net/thumbs/120/apple/354/artist_1f9d1-200d-1f3a8.png" ];
            avatarUrls.forEach((url, i) => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = `ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© ${i + 1}`;
                img.className = 'avatar-option';
                img.loading = 'lazy';
                grid.appendChild(img);
            });
        }
        
        selectAvatar(element) {
            this.getAllEl('.avatar-option.selected, .avatar-upload-btn.selected').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            this.gameState.avatar = element.src;
            this.dom.confirmAvatarBtn.disabled = false;
        }

        handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    this.dom.imageToCrop.src = e.target.result;
                    this.showModal('avatarEditor');
                    setTimeout(() => {
                        if (this.cropper) this.cropper.destroy();
                        this.cropper = new Cropper(this.dom.imageToCrop, { aspectRatio: 1, viewMode: 1, autoCropArea: 1 });
                    }, 300);
                };
                reader.readAsDataURL(file);
            }
        }
        
        saveCroppedAvatar() {
            if (!this.cropper) return;
            const croppedUrl = this.cropper.getCroppedCanvas({ width: 256, height: 256 }).toDataURL('image/png');
            let customAvatar = this.getEl('#custom-avatar');
            if (!customAvatar) {
                customAvatar = document.createElement('img');
                customAvatar.id = 'custom-avatar';
                customAvatar.className = 'avatar-option';
                this.getEl('.avatar-upload-btn').after(customAvatar);
            }
            customAvatar.src = croppedUrl;
            this.selectAvatar(customAvatar);
            this.hideModal('avatarEditor');
        }
        
        // =============================================
        // Sharing
        // =============================================

        getShareText() {
            const stats = this._calculateFinalStats();
            return `ğŸ† Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ğŸ†\n\n` +  
                   `Ø§Ù„Ø§Ø³Ù…: ${stats.name}\n` +
                   `Ø§Ù„Ù†Ù‚Ø§Ø·: ${this.formatNumber(stats.score)}\n` +
                   `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${stats.level}\n` +
                   `Ø§Ù„Ø¯Ù‚Ø©: ${stats.accuracy}%\n` +
                   `Ø§Ù„Ø£Ø¯Ø§Ø¡: ${stats.performance_rating}`;
        }
        
        shareOnX() {
            const text = this.getShareText() + `\n\nğŸ”— ØªØ­Ø¯Ø§Ù†ÙŠ Ø§Ù„Ø¢Ù†!\n${window.location.href}`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
        }

        shareOnInstagram() {
            navigator.clipboard.writeText(this.getShareText())
                .then(() => this.showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§!", "success"))
                .catch(() => this.showToast("ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©.", "error"));
        }
        setupGameUI() {
            this.getEl('#playerAvatar').src = this.gameState.avatar;
            this.getEl('#playerName').textContent = this.gameState.name;
            this.getEl('#playerId').textContent = this.gameState.playerId;
        }


    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.dataset.theme = savedTheme;
        document.querySelector('.theme-toggle-btn').textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        new QuizGame();
    });
    </script>
</body>
</html>
