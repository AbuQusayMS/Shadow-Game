<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقة المعلومات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* أنماط CSS المضمنة */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0B2545;
            color: white;
            transition: background-color 0.5s, color 0.5s;
        }

        .dark-mode {
            background-color: #0B2545;
            color: white;
        }

        .light-mode {
            background-color: #F0F2F5;
            color: #0B2545;
        }

        .light-mode .btn-primary {
            background-color: #E53935;
        }

        .light-mode .btn-secondary {
            background-color: #1E3A8A;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeout {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Custom scrollbar for avatars */
        .avatar-scroll::-webkit-scrollbar {
            height: 8px;
        }

        .avatar-scroll::-webkit-scrollbar-thumb {
            background-color: #4FC3F7;
            border-radius: 4px;
        }

        .avatar-scroll::-webkit-scrollbar-track {
            background-color: #1E3A8A;
            border-radius: 4px;
        }

        /* Tailwind-like utility classes */
        .min-h-screen {
            min-height: 100vh;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        .hidden {
            display: none;
        }

        .max-w-2xl {
            max-width: 42rem;
        }

        .max-w-4xl {
            max-width: 56rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-2 {
            padding: 0.5rem;
        }

        .p-8 {
            padding: 2rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-8 {
            margin-top: 2rem;
        }

        .mr-4 {
            margin-right: 1rem;
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-3xl {
            font-size: 1.875rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-base {
            font-size: 1rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-light {
            font-weight: 300;
        }

        .leading-relaxed {
            line-height: 1.625;
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .rounded-2xl {
            border-radius: 1rem;
        }

        .rounded-t-2xl {
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        .border-2 {
            border-width: 2px;
        }

        .border-4 {
            border-width: 4px;
        }

        .border-transparent {
            border-color: transparent;
        }

        .border-gray-700 {
            border-color: rgba(55, 65, 81, 0.5);
        }

        .border-b {
            border-bottom-width: 1px;
        }

        .bg-\[\#0B2545\] {
            background-color: #0B2545;
        }

        .bg-\[\#1E3A8A\] {
            background-color: #1E3A8A;
        }

        .bg-\[\#E53935\] {
            background-color: #E53935;
        }

        .bg-\[\#4FC3F7\] {
            background-color: #4FC3F7;
        }

        .bg-\[\#FFB74D\] {
            background-color: #FFB74D;
        }

        .bg-\[\#FFD700\] {
            background-color: #FFD700;
        }

        .bg-\[\#FF8BA7\] {
            background-color: #FF8BA7;
        }

        .bg-gray-300 {
            background-color: #D1D5DB;
        }

        .bg-gray-600 {
            background-color: #4B5563;
        }

        .bg-gray-700 {
            background-color: #374151;
        }

        .bg-black {
            background-color: #000;
        }

        .bg-opacity-70 {
            --tw-bg-opacity: 0.7;
        }

        .bg-green-500 {
            background-color: #10B981;
        }

        .bg-red-500 {
            background-color: #EF4444;
        }

        .bg-yellow-500 {
            background-color: #F59E0B;
        }

        .text-white {
            color: white;
        }

        .text-gray-300 {
            color: #D1D5DB;
        }

        .text-gray-400 {
            color: #9CA3AF;
        }

        .text-\[\#4FC3F7\] {
            color: #4FC3F7;
        }

        .text-\[\#FFD700\] {
            color: #FFD700;
        }

        .text-\[\#FFB74D\] {
            color: #FFB74D;
        }

        .text-\[\#FF8BA7\] {
            color: #FF8BA7;
        }

        .text-\[\#E53935\] {
            color: #E53935;
        }

        .text-\[\#0B2545\] {
            color: #0B2545;
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .transition-colors {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .transition-transform {
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .duration-300 {
            transition-duration: 300ms;
        }

        .duration-500 {
            transition-duration: 500ms;
        }

        .transform {
            transform: translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
        }

        .scale-100 {
            --tw-scale-x: 1;
            --tw-scale-y: 1;
            transform: translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
        }

        .scale-90 {
            --tw-scale-x: .9;
            --tw-scale-y: .9;
            transform: translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
        }

        .hover\:scale-105:hover {
            --tw-scale-x: 1.05;
            --tw-scale-y: 1.05;
            transform: translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
        }

        .hover\:scale-110:hover {
            --tw-scale-x: 1.1;
            --tw-scale-y: 1.1;
            transform: translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
        }

        .hover\:bg-\[\#4FC3F7\]:hover {
            background-color: #4FC3F7;
        }

        .hover\:underline:hover {
            text-decoration: underline;
        }

        .hover\:border-\[\#4FC3F7\]:hover {
            border-color: #4FC3F7;
        }

        .focus\:outline-none:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
        }

        .focus\:ring-2:focus {
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }

        .focus\:ring-\[\#FFB74D\]:focus {
            --tw-ring-opacity: 1;
            --tw-ring-color: rgba(255, 183, 77, var(--tw-ring-opacity));
        }

        .disabled\:opacity-50:disabled {
            opacity: 0.5;
        }

        .disabled\:cursor-not-allowed:disabled {
            cursor: not-allowed;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .cursor-not-allowed {
            cursor: not-allowed;
        }

        .opacity-0 {
            opacity: 0;
        }

        .opacity-50 {
            opacity: 0.5;
        }

        .opacity-100 {
            opacity: 1;
        }

        .overflow-hidden {
            overflow: hidden;
        }

        .overflow-x-auto {
            overflow-x: auto;
        }

        .overflow-y-auto {
            overflow-y: auto;
        }

        .relative {
            position: relative;
        }

        .fixed {
            position: fixed;
        }

        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .z-50 {
            z-index: 50;
        }

        .grid {
            display: grid;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .grid-cols-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .grid-cols-6 {
            grid-template-columns: repeat(6, minmax(0, 1fr));
        }

        .justify-items-center {
            justify-items: center;
        }

        .flex-grow {
            flex-grow: 1;
        }

        .ring-2 {
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }

        .ring-4 {
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }

        .ring-\[\#FFD700\] {
            --tw-ring-opacity: 1;
            --tw-ring-color: rgba(255, 215, 0, var(--tw-ring-opacity));
        }

        .ring-green-300 {
            --tw-ring-opacity: 1;
            --tw-ring-color: rgba(110, 231, 183, var(--tw-ring-opacity));
        }

        .line-through {
            text-decoration-line: line-through;
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(-25%);
                animation-timing-function: cubic-bezier(0.8,0,1,1);
            }
            50% {
                transform: none;
                animation-timing-function: cubic-bezier(0,0,0.2,1);
            }
        }

        .table-auto {
            table-layout: auto;
        }

        .table {
            display: table;
        }

        .table-row {
            display: table-row;
        }

        .table-cell {
            display: table-cell;
        }

        .h-16 {
            height: 4rem;
        }

        .h-2 {
            height: 0.5rem;
        }

        .h-4 {
            height: 1rem;
        }

        .h-24 {
            height: 6rem;
        }

        .h-32 {
            height: 8rem;
        }

        .w-16 {
            width: 4rem;
        }

        .w-24 {
            width: 6rem;
        }

        .w-32 {
            width: 8rem;
        }

        .w-40 {
            width: 10rem;
        }

        .w-48 {
            width: 12rem;
        }

        .pb-4 {
            padding-bottom: 1rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .px-1 {
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .px-8 {
            padding-left: 2rem;
            padding-right: 2rem;
        }

        .-mt-8 {
            margin-top: -2rem;
        }

        .-mx-8 {
            margin-left: -2rem;
            margin-right: -2rem;
        }

        .col-span-5 {
            grid-column: span 5 / span 5;
        }

        @media (min-width: 768px) {
            .md\:flex-row {
                flex-direction: row;
            }
            
            .md\:w-auto {
                width: auto;
            }
            
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            
            .md\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
            
            .md\:space-x-4 > * + * {
                margin-left: 1rem;
            }
            
            .md\:space-y-0 > * + * {
                margin-top: 0;
            }
            
            .md\:table-cell {
                display: table-cell;
            }
            
            .md\:text-base {
                font-size: 1rem;
            }
            
            .md\:px-4 {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .lg\:text-5xl {
                font-size: 3rem;
            }
            
            .lg\:justify-start {
                justify-content: flex-start;
            }
            
            .lg\:gap-4 {
                gap: 1rem;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Main Screens Container -->
    <div id="main-container" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Splash Screen (Page 1) -->
        <div id="splash-screen" class="w-full max-w-2xl text-center transition-all duration-500 transform scale-100 opacity-100">
            <div class="flex items-center justify-center lg:justify-start lg:gap-4 mb-4">
                <i class="fas fa-brain text-4xl lg:text-5xl text-[#FF8BA7]"></i>
                <h1 class="text-3xl lg:text-5xl font-bold text-[#4FC3F7] mr-4">مسابقة المعلومات</h1>
            </div>
            <p class="text-sm lg:text-base text-gray-300 font-light mb-8">
                اختبر معلوماتك بمجموعة تحديات قصيرة وممتعة!
            </p>
            <p class="text-lg lg:text-xl text-white leading-relaxed mb-8">
                اختبر معلوماتك في مسابقة تفاعلية قصيرة — جمع نقاط، استخدم أدوات المساعدة، وتنافس للوصول إلى لوح الصدارة.
            </p>

            <!-- Key Features -->
            <ul class="text-right text-white mb-10 space-y-4">
                <li class="flex items-center justify-end gap-2">
                    <span class="text-lg lg:text-xl font-medium">
                        اجمع النقاط بالإجابات الصحيحة — تحصل +100 نقطة لكل إجابة صحيحة.
                    </span>
                    <i class="fas fa-bullseye text-[#FFB74D]"></i>
                </li>
                <li class="flex items-center justify-end gap-2">
                    <span class="text-lg lg:text-xl font-medium">
                        محاولات مرنة للإجابة — المحاولات غير محدودة.
                    </span>
                    <i class="fas fa-redo-alt text-[#4FC3F7]"></i>
                </li>
                <li class="flex items-center justify-end gap-2">
                    <span class="text-lg lg:text-xl font-medium">
                        السؤال المستحيل — فرصة لتعويض الخسارة.
                    </span>
                    <i class="fas fa-infinity text-[#E53935]"></i>
                </li>
            </ul>

            <div class="mb-8">
                <p class="text-sm lg:text-base text-gray-400">
                    في حال واجهت أي مشكلة، راسل المسؤول على 
                    <a href="https://x.com/_MS_AbuQusay?t=xxNvSpL0aOdiKHUE6ZuM6A&s=09" target="_blank" class="text-[#4FC3F7] hover:underline">إكس</a> أو 
                    <a href="https://www.instagram.com/ms_abuqusay?igsh=MXc2ZWptd2FkamN0" target="_blank" class="text-[#FF8BA7] hover:underline">إنستغرام</a>.
                </p>
            </div>

            <!-- Buttons -->
            <div class="space-y-4 md:space-y-0 md:space-x-4">
                <button id="start-btn" class="btn-primary w-full md:w-auto px-8 py-4 bg-[#E53935] text-white text-lg font-bold rounded-full transition-transform transform hover:scale-105 shadow-lg">
                    ابدأ اللعب الآن
                </button>
                <button id="leaderboard-btn" class="btn-secondary w-full md:w-auto px-8 py-4 bg-[#1E3A8A] text-white text-lg font-bold rounded-full transition-transform transform hover:scale-105 shadow-lg">
                    الإحصائيات
                </button>
            </div>
        </div>

        <!-- Avatar Selection Screen -->
        <div id="avatar-screen" class="hidden w-full max-w-4xl transition-all duration-500 transform scale-90 opacity-0">
            <h2 class="text-3xl font-bold text-center mb-8 text-[#4FC3F7]">اختر صورتك الرمزية</h2>
            <div id="avatar-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 justify-items-center avatar-scroll overflow-x-auto pb-4">
                <!-- سيتم إضافة الصور الرمزية ديناميكيًا باستخدام JavaScript -->
            </div>
            <div class="text-center mt-12">
                <button id="next-to-name-btn" class="btn-primary px-8 py-4 bg-[#E53935] text-white text-lg font-bold rounded-full transition-transform transform hover:scale-105 shadow-lg opacity-50 cursor-not-allowed" disabled>
                    التالي
                </button>
            </div>
        </div>

        <!-- Name Input Modal -->
        <div id="name-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="bg-[#1E3A8A] p-8 rounded-2xl shadow-2xl w-full max-w-md transition-all duration-500 transform scale-90">
                <h3 class="text-2xl font-bold text-center mb-6 text-[#4FC3F7]">ما هو اسمك؟</h3>
                <input type="text" id="name-input" placeholder="اكتب اسمك هنا" class="w-full p-4 text-lg text-center bg-[#0B2545] rounded-full border-2 border-[#4FC3F7] focus:outline-none focus:ring-2 focus:ring-[#FFB74D] transition-colors">
                <p id="name-error" class="text-sm text-[#FFB74D] text-center mt-2 hidden">الاسم يجب أن يكون بين 3 و 15 حرفًا.</p>
                <div class="text-center mt-8">
                    <button id="confirm-name-btn" class="btn-primary px-8 py-4 bg-[#E53935] text-white text-lg font-bold rounded-full transition-transform transform hover:scale-105 shadow-lg">
                        موافق
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden w-full max-w-4xl transition-all duration-500 transform scale-90 opacity-0">
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-2">
                    <button id="end-quiz-btn" class="btn-sm px-4 py-2 bg-[#E53935] text-white rounded-full text-sm font-bold transition-transform transform hover:scale-105">إنهاء المسابقة</button>
                    <button id="impossible-btn" class="btn-sm px-4 py-2 bg-[#FFB74D] text-white rounded-full text-sm font-bold transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        السؤال المستحيل
                    </button>
                </div>
                <div class="flex flex-col items-center">
                    <span id="question-status" class="text-lg font-bold text-[#4FC3F7]"></span>
                    <div class="w-40 h-2 bg-[#1E3A8A] rounded-full mt-2 overflow-hidden">
                        <div id="progress-bar" class="h-full bg-[#E53935] transition-all duration-300"></div>
                    </div>
                </div>
                <div>
                    <button id="theme-toggle" class="p-2 rounded-full bg-[#1E3A8A] hover:bg-[#4FC3F7] transition-colors">
                        <i class="fas fa-sun text-[#FFB74D]"></i>
                    </button>
                </div>
            </div>

            <!-- Player Card -->
            <div class="flex items-center gap-4 bg-[#1E3A8A] p-4 rounded-xl shadow-lg mb-8">
                <img id="player-avatar" src="" alt="Avatar" class="w-16 h-16 rounded-full border-2 border-[#4FC3F7]">
                <div class="flex-grow">
                    <h4 id="player-name-display" class="text-xl font-bold text-[#FFD700]"></h4>
                    <p class="text-sm text-gray-300">النقاط: <span id="player-score">100</span></p>
                    <p class="text-sm text-gray-300">مرات التخطي: <span id="skip-count">0</span> (<span id="skip-cost-display">100</span> نقطة)</p>
                </div>
            </div>

            <!-- Help Tools -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <button data-help="fifty-fifty" class="help-btn w-full p-4 bg-[#1E3A8A] text-white rounded-xl shadow-lg transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-hand-holding-usd text-[#4FC3F7]"></i>
                    <p class="mt-2 text-sm">50:50</p>
                </button>
                <button data-help="freeze" class="help-btn w-full p-4 bg-[#1E3A8A] text-white rounded-xl shadow-lg transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-snowflake text-[#4FC3F7]"></i>
                    <p class="mt-2 text-sm">تجميد الوقت</p>
                </button>
                <button data-help="swap" class="help-btn w-full p-4 bg-[#1E3A8A] text-white rounded-xl shadow-lg transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-exchange-alt text-[#4FC3F7]"></i>
                    <p class="mt-2 text-sm">تغيير السؤال</p>
                </button>
                <button data-help="skip" class="help-btn w-full p-4 bg-[#1E3A8A] text-white rounded-xl shadow-lg transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-forward text-[#4FC3F7]"></i>
                    <p class="mt-2 text-sm">السؤال التالي</p>
                </button>
            </div>

            <!-- Timer -->
            <div class="w-full h-4 bg-[#1E3A8A] rounded-full mb-8 overflow-hidden">
                <div id="timer-bar" class="h-full bg-[#FFB74D] transition-all duration-100"></div>
            </div>

            <!-- Question and Answers -->
            <div class="bg-[#1E3A8A] p-6 rounded-2xl shadow-2xl mb-8">
                <h3 id="question-text" class="text-2xl font-bold text-center mb-6 text-[#FFD700]"></h3>
                <div id="answers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- سيتم إضافة الأسئلة ديناميكيًا باستخدام JavaScript -->
                </div>
            </div>
        </div>

        <!-- End Quiz Confirmation Modal -->
        <div id="end-quiz-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="bg-[#1E3A8A] p-8 rounded-2xl shadow-2xl w-full max-w-md transition-all duration-500 transform scale-90">
                <h3 class="text-2xl font-bold text-center mb-6 text-[#E53935]">إنهاء المسابقة</h3>
                <p class="text-lg text-center text-white mb-6">سيتم احتساب النقاط التي جمعتها حتى الآن. هل تريد إنهاء المسابقة؟</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-end-btn" class="btn-primary px-6 py-3 bg-[#E53935] text-white rounded-full text-lg font-bold transition-transform transform hover:scale-105 shadow-lg">تأكيد</button>
                    <button id="cancel-end-btn" class="btn-secondary px-6 py-3 bg-[#1E3A8A] text-white rounded-full text-lg font-bold transition-transform transform hover:scale-105 shadow-lg">إلغاء</button>
                </div>
            </div>
        </div>

        <!-- Impossible Question Modal -->
        <div id="impossible-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="bg-[#1E3A8A] p-8 rounded-2xl shadow-2xl w-full max-w-md transition-all duration-500 transform scale-90">
                <div class="flex items-center justify-center gap-2 bg-[#FFB74D] text-[#0B2545] p-3 rounded-t-2xl -mt-8 -mx-8 mb-6">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3 class="text-2xl font-bold">السؤال المستحيل</h3>
                </div>
                <p class="text-lg text-center text-white mb-6">فرصتك لتعويض الخسارة! لا يمكن استخدام أي مساعدات في هذا السؤال.</p>
                <div class="flex justify-center gap-4">
                    <button id="accept-impossible-btn" class="btn-primary px-6 py-3 bg-[#E53935] text-white rounded-full text-lg font-bold transition-transform transform hover:scale-105 shadow-lg">قبول التحدي</button>
                    <button id="decline-impossible-btn" class="btn-secondary px-6 py-3 bg-[#1E3A8A] text-white rounded-full text-lg font-bold transition-transform transform hover:scale-105 shadow-lg">عرض النتائج</button>
                </div>
            </div>
        </div>

        <!-- Final Results Screen -->
        <div id="results-screen" class="hidden w-full max-w-2xl transition-all duration-500 transform scale-90 opacity-0">
            <h2 class="text-3xl font-bold text-center mb-8 text-[#FFD700]">
                النتائج
                <i class="fas fa-trophy text-[#FFD700] ml-2 animate-bounce"></i>
            </h2>
            <div class="bg-[#1E3A8A] p-8 rounded-2xl shadow-2xl mb-8">
                <h3 class="text-xl font-bold text-center text-[#4FC3F7] mb-6">ملخص الأداء</h3>
                <div class="space-y-4 text-center">
                    <p class="text-lg">الاسم: <span id="final-name" class="font-bold"></span></p>
                    <p class="text-lg">النقاط الكلية: <span id="final-score" class="font-bold"></span></p>
                    <p class="text-lg">المدة: <span id="final-duration" class="font-bold"></span></p>
                    <p class="text-lg">الإجابات الصحيحة: <span id="final-correct" class="font-bold"></span></p>
                    <p class="text-lg">الإجابات الخاطئة: <span id="final-wrong" class="font-bold"></span></p>
                    <p class="text-lg">مرات التخطي: <span id="final-skips" class="font-bold"></span></p>
                    <p class="text-lg">السؤال المستحيل: <span id="final-impossible" class="font-bold"></span></p>
                </div>
            </div>
            
            <div class="bg-[#1E3A8A] p-8 rounded-2xl shadow-2xl mb-8">
                <h3 class="text-xl font-bold text-center text-[#4FC3F7] mb-4">التقييم العام</h3>
                <div class="flex items-center justify-center gap-4">
                    <div id="performance-bar-container" class="w-48 h-2 bg-gray-600 rounded-full overflow-hidden">
                        <div id="performance-bar" class="h-full transition-all duration-500"></div>
                    </div>
                    <p id="performance-text" class="text-lg font-bold"></p>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 justify-center mb-8">
                <button id="play-again-btn" class="btn-primary w-full md:w-auto px-8 py-4 bg-[#E53935] text-white text-lg font-bold rounded-full transition-transform transform hover:scale-105 shadow-lg">
                    العب مرة أخرى
                </button>
                <button id="back-to-start-btn" class="btn-secondary w-full md:w-auto px-8 py-4 bg-[#1E3A8A] text-white text-lg font-bold rounded-full transition-transform transform hover:scale-105 shadow-lg">
                    العودة للبداية
                </button>
            </div>
            <div class="flex justify-center gap-4">
                <a id="share-x-btn" href="#" target="_blank" class="p-4 bg-[#1E3A8A] text-white rounded-full transition-transform transform hover:scale-110 shadow-lg">
                    <i class="fab fa-twitter"></i>
                </a>
                <a id="share-instagram-btn" href="#" target="_blank" class="p-4 bg-[#1E3A8A] text-white rounded-full transition-transform transform hover:scale-110 shadow-lg">
                    <i class="fab fa-instagram"></i>
                </a>
            </div>
        </div>
        
        <!-- Leaderboard Screen -->
        <div id="leaderboard-screen" class="hidden w-full max-w-4xl transition-all duration-500 transform scale-90 opacity-0">
            <h2 class="text-3xl font-bold text-center mb-8 text-[#FFD700]">
                لوحة الصدارة
                <i class="fas fa-award text-[#FFD700] ml-2"></i>
            </h2>
            <div class="bg-[#1E3A8A] p-6 rounded-2xl shadow-2xl">
                <table class="w-full text-right table-auto">
                    <thead>
                        <tr class="text-sm md:text-base text-gray-300 border-b border-[#4FC3F7]">
                            <th class="py-2 px-1 md:px-4">الترتيب</th>
                            <th class="py-2 px-1 md:px-4">الاسم</th>
                            <th class="py-2 px-1 md:px-4 hidden md:table-cell">المستوى</th>
                            <th class="py-2 px-1 md:px-4">النقاط</th>
                            <th class="py-2 px-1 md:px-4">السؤال المستحيل</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="text-sm md:text-base">
                        <!-- Leaderboard rows will be injected here by JS -->
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-8">
                <button id="back-from-leaderboard" class="btn-secondary px-6 py-3 bg-[#1E3A8A] text-white rounded-full text-lg font-bold transition-transform transform hover:scale-105 shadow-lg">
                    العودة للبداية
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables and constants
        const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzB9cru35ndWmWYsEqe46NlrvZgj64HhCIZJ0j7SLln3VDSl2S7rAOMDGxLwEzR_ClS/exec";
        const QUIZ_QUESTIONS = [
            {
                question: "ما هي عاصمة اليابان؟",
                options: ["بكين", "طوكيو", "سيول", "بانكوك"],
                answer: "طوكيو"
            },
            {
                question: "ما هو أكبر محيط في العالم؟",
                options: ["المحيط الأطلسي", "المحيط الهندي", "المحيط الهادئ", "المحيط المتجمد الشمالي"],
                answer: "المحيط الهادئ"
            },
            {
                question: "كم عدد الكواكب في النظام الشمسي؟",
                options: ["7", "8", "9", "10"],
                answer: "8"
            },
            {
                question: "ما هو أسرع حيوان على وجه الأرض؟",
                options: ["الأسد", "الفهد الصياد", "الحصان", "النسر"],
                answer: "الفهد الصياد"
            },
            {
                question: "ما هو العنصر الكيميائي الذي رمزه 'O'؟",
                options: ["الهيدروجين", "النيتروجين", "الأكسجين", "الكربون"],
                answer: "الأكسجين"
            },
            {
                question: "من هو مؤلف كتاب 'الجريمة والعقاب'؟",
                options: ["تولستوي", "دوستويفسكي", "تشيخوف", "غوغول"],
                answer: "دوستويفسكي"
            },
            {
                question: "ما هو أطول نهر في العالم؟",
                options: ["نهر النيل", "نهر الأمازون", "نهر يانغتسي", "نهر المسيسيبي"],
                answer: "نهر الأمازون"
            },
            {
                question: "ما هي العملة الرسمية للولايات المتحدة؟",
                options: ["اليورو", "الجنيه", "الدولار", "الين"],
                answer: "الدولار"
            },
            {
                question: "ما هو الكوكب الأحمر؟",
                options: ["المريخ", "المشتري", "الزهرة", "عطارد"],
                answer: "المريخ"
            },
            {
                question: "ما هي أكبر دولة في العالم من حيث المساحة؟",
                options: ["كندا", "الصين", "روسيا", "الولايات المتحدة"],
                answer: "روسيا"
            },
            {
                question: "ما هو الرمز الكيميائي للماء؟",
                options: ["O2", "H2O", "CO2", "NaCl"],
                answer: "H2O"
            },
            {
                question: "من الذي رسم لوحة الموناليزا؟",
                options: ["مايكل أنجلو", "ليوناردو دا فينشي", "رفائيل", "فان جوخ"],
                answer: "ليوناردو دا فينشي"
            },
            {
                question: "ما هي أسرع حشرة في العالم؟",
                options: ["اليعسوب", "الصرصور", "النحلة", "الذباب"],
                answer: "اليعسوب"
            },
            {
                question: "ما هو الحيوان الذي يستطيع النوم وهو واقف؟",
                options: ["الخيل", "الدب", "الأسد", "القط"],
                answer: "الخيل"
            },
            {
                question: "ما هو أكبر عضو في جسم الإنسان؟",
                options: ["الكبد", "القلب", "الجلد", "الرئتين"],
                answer: "الجلد"
            }
        ];
        
        const IMPOSSIBLE_QUESTION = {
            question: "من هو أول من سافر إلى الفضاء؟",
            options: ["نيل أرمسترونغ", "يوري غاغارين", "جون غلين", "آلان شيبرد"],
            answer: "يوري غاغارين"
        };
        
        // State Management
        let gameState = {
            playerName: '',
            avatarId: '',
            score: 100,
            currentQuestionIndex: 0,
            questions: [],
            correctAnswers: 0,
            wrongAnswers: 0,
            skips: 0,
            usedFiftyFifty: false,
            usedFreeze: false,
            usedSwap: false,
            impossibleUsed: false,
            impossibleCorrect: false,
            startTime: null,
            endTime: null,
            duration: 0,
            skipCost: 100,
            timer: null,
            timeLeft: 80,
            isImpossible: false,
        };

        // DOM Elements
        const mainContainer = document.getElementById('main-container');
        const splashScreen = document.getElementById('splash-screen');
        const avatarScreen = document.getElementById('avatar-screen');
        const nameModal = document.getElementById('name-modal');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen');

        const startBtn = document.getElementById('start-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const backFromLeaderboard = document.getElementById('back-from-leaderboard');
        const nextToNameBtn = document.getElementById('next-to-name-btn');
        const confirmNameBtn = document.getElementById('confirm-name-btn');
        const nameInput = document.getElementById('name-input');
        const nameError = document.getElementById('name-error');
        const avatarGrid = document.getElementById('avatar-grid');
        const playerAvatar = document.getElementById('player-avatar');
        const playerNameDisplay = document.getElementById('player-name-display');
        const playerScoreDisplay = document.getElementById('player-score');
        const skipCountDisplay = document.getElementById('skip-count');
        const skipCostDisplay = document.getElementById('skip-cost-display');
        const questionStatus = document.getElementById('question-status');
        const questionText = document.getElementById('question-text');
        const answersGrid = document.getElementById('answers-grid');
        const endQuizBtn = document.getElementById('end-quiz-btn');
        const impossibleBtn = document.getElementById('impossible-btn');
        const endQuizModal = document.getElementById('end-quiz-modal');
        const confirmEndBtn = document.getElementById('confirm-end-btn');
        const cancelEndBtn = document.getElementById('cancel-end-btn');
        const helpBtns = document.querySelectorAll('.help-btn');
        const timerBar = document.getElementById('timer-bar');
        const progressBar = document.getElementById('progress-bar');
        const impossibleModal = document.getElementById('impossible-modal');
        const acceptImpossibleBtn = document.getElementById('accept-impossible-btn');
        const declineImpossibleBtn = document.getElementById('decline-impossible-btn');
        const finalName = document.getElementById('final-name');
        const finalScore = document.getElementById('final-score');
        const finalDuration = document.getElementById('final-duration');
        const finalCorrect = document.getElementById('final-correct');
        const finalWrong = document.getElementById('final-wrong');
        const finalSkips = document.getElementById('final-skips');
        const finalImpossible = document.getElementById('final-impossible');
        const performanceBar = document.getElementById('performance-bar');
        const performanceText = document.getElementById('performance-text');
        const playAgainBtn = document.getElementById('play-again-btn');
        const backToStartBtn = document.getElementById('back-to-start-btn');
        const shareXBtn = document.getElementById('share-x-btn');
        const shareInstagramBtn = document.getElementById('share-instagram-btn');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const leaderboardBody = document.getElementById('leaderboard-body');
        
        // Avatars - Use a simple collection for demo
        const avatars = [
            'https://placehold.co/150x150/4FC3F7/0B2545?text=Av1',
            'https://placehold.co/150x150/FFB74D/0B2545?text=Av2',
            'https://placehold.co/150x150/FF8BA7/0B2545?text=Av3',
            'https://placehold.co/150x150/E53935/FFFFFF?text=Av4',
            'https://placehold.co/150x150/1E3A8A/FFFFFF?text=Av5',
            'https://placehold.co/150x150/FFD700/0B2545?text=Av6',
            'https://placehold.co/150x150/AEC9F7/0B2545?text=Av7',
            'https://placehold.co/150x150/E0E0E0/0B2545?text=Av8',
            'https://placehold.co/150x150/8BC34A/0B2545?text=Av9',
        ];

        // Functions to manage screen visibility
        const showScreen = (screen) => {
            const allScreens = [splashScreen, avatarScreen, quizScreen, resultsScreen, leaderboardScreen];
            allScreens.forEach(s => {
                s.classList.add('hidden', 'scale-90', 'opacity-0');
            });
            screen.classList.remove('hidden', 'scale-90', 'opacity-0');
            screen.classList.add('scale-100', 'opacity-100');
        };
        
        const showModal = (modal) => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-90');
            }, 10);
        };
        
        const hideModal = (modal) => {
            modal.querySelector('div').classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        // Utility functions
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };
        
        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            let bgColor = '';
            if (type === 'success') bgColor = 'bg-green-500';
            else if (type === 'error') bgColor = 'bg-red-500';
            else if (type === 'warning') bgColor = 'bg-yellow-500';
            else bgColor = 'bg-gray-700';

            toast.className = `toast p-4 rounded-xl shadow-lg text-white font-bold mb-2 ${bgColor} text-sm md:text-base`;
            toast.textContent = message;

            const toastContainer = document.getElementById('toast-container');
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        };

        const getPerformanceLevel = (score, total) => {
            const percentage = (score / total) * 100;
            if (percentage >= 90) return { level: 'ممتاز', color: '#00C853' };
            if (percentage >= 70) return { level: 'جيد جداً', color: '#64DD17' };
            if (percentage >= 50) return { level: 'جيد', color: '#FFD700' };
            if (percentage >= 30) return { level: 'مقبول', color: '#FFB74D' };
            if (percentage >= 10) return { level: 'ضعيف', color: '#FF5722' };
            if (percentage >= 0) return { level: 'سيء', color: '#E53935' };
            return { level: 'سيء جداً', color: '#9E2D2D' };
        };

        // Quiz Logic
        const startGame = () => {
            // Reset game state
            gameState = {
                ...gameState,
                score: 100,
                currentQuestionIndex: 0,
                correctAnswers: 0,
                wrongAnswers: 0,
                skips: 0,
                usedFiftyFifty: false,
                usedFreeze: false,
                usedSwap: false,
                impossibleUsed: false,
                impossibleCorrect: false,
                startTime: new Date(),
                endTime: null,
                duration: 0,
                skipCost: 100,
                isImpossible: false,
            };

            // Shuffle questions and prepare for the game
            gameState.questions = shuffleArray([...QUIZ_QUESTIONS]);
            
            // Update UI
            playerAvatar.src = gameState.avatarId;
            playerNameDisplay.textContent = gameState.playerName;
            playerScoreDisplay.textContent = gameState.score;
            skipCostDisplay.textContent = gameState.skipCost;
            skipCountDisplay.textContent = gameState.skips;
            
            helpBtns.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            impossibleBtn.disabled = false;
            impossibleBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            showScreen(quizScreen);
            loadQuestion();
        };

        const loadQuestion = () => {
            // Check for game end
            if (gameState.currentQuestionIndex >= gameState.questions.length) {
                // Time for impossible question or game over
                if (!gameState.impossibleUsed && !gameState.isImpossible) {
                    showModal(impossibleModal);
                    return;
                } else {
                    endGame();
                    return;
                }
            }
            
            if (gameState.timer) clearInterval(gameState.timer);
            
            const questionData = gameState.questions[gameState.currentQuestionIndex];
            
            questionStatus.textContent = `السؤال ${gameState.currentQuestionIndex + 1} من ${QUIZ_QUESTIONS.length}`;
            
            questionText.textContent = questionData.question;
            answersGrid.innerHTML = '';
            
            // Shuffle answers
            const shuffledOptions = shuffleArray([...questionData.options]);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = "answer-btn w-full p-4 bg-[#1E3A8A] text-white rounded-xl shadow-lg transition-colors duration-300 transform hover:scale-105";
                button.onclick = () => handleAnswer(option, questionData.answer);
                answersGrid.appendChild(button);
            });
            
            startTimer();
        };

        const loadImpossibleQuestion = () => {
             if (gameState.timer) clearInterval(gameState.timer);

            gameState.isImpossible = true;
            gameState.impossibleUsed = true;
            
            questionStatus.textContent = `السؤال المستحيل`;
            questionText.textContent = IMPOSSIBLE_QUESTION.question;
            answersGrid.innerHTML = '';
            
            const shuffledOptions = shuffleArray([...IMPOSSIBLE_QUESTION.options]);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = "answer-btn w-full p-4 bg-[#1E3A8A] text-white rounded-xl shadow-lg transition-colors duration-300 transform hover:scale-105";
                button.onclick = () => handleAnswer(option, IMPOSSIBLE_QUESTION.answer);
                answersGrid.appendChild(button);
            });
            
            // Disable all help buttons for impossible question
            helpBtns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
            impossibleBtn.disabled = true;
            impossibleBtn.classList.add('opacity-50', 'cursor-not-allowed');

            startTimer();
        };

        const startTimer = () => {
            gameState.timeLeft = 80;
            timerBar.style.width = '100%';
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                timerBar.style.width = `${(gameState.timeLeft / 80) * 100}%`;
                
                if (gameState.timeLeft <= 20) {
                    timerBar.classList.remove('bg-[#FFB74D]');
                    timerBar.classList.add('bg-[#E53935]');
                } else {
                    timerBar.classList.remove('bg-[#E53935]');
                    timerBar.classList.add('bg-[#FFB74D]');
                }
                
                if (gameState.timeLeft <= 0) {
                    handleAnswer(null, null); // Incorrect answer
                }
            }, 1000);
        };
        
        const stopTimer = () => {
            if (gameState.timer) clearInterval(gameState.timer);
        };

        const handleAnswer = (selectedOption, correctAnswer) => {
            stopTimer();
            const answerBtns = document.querySelectorAll('.answer-btn');
            
            const isCorrect = selectedOption === correctAnswer;

            if (isCorrect) {
                gameState.score += 100;
                if(gameState.isImpossible) {
                    gameState.impossibleCorrect = true;
                    showToast('إجابة صحيحة - مكافأة خاصة!', 'success');
                } else {
                    gameState.correctAnswers++;
                    showToast('إجابة صحيحة — +100 نقطة', 'success');
                }
                document.querySelector(`button[onclick*="${selectedOption}"]`).classList.add('bg-green-500');
            } else {
                gameState.score -= 100;
                if(gameState.isImpossible) {
                    showToast('إجابة خاطئة - لا توجد مكافأة.', 'error');
                } else {
                    gameState.wrongAnswers++;
                    showToast('إجابة خاطئة — -100 نقطة', 'error');
                }
                if (selectedOption) {
                     document.querySelector(`button[onclick*="${selectedOption}"]`).classList.add('bg-red-500');
                }
                // Show the correct answer
                const correctBtn = document.querySelector(`button[onclick*="${correctAnswer}"]`);
                if(correctBtn) {
                     correctBtn.classList.add('bg-green-500', 'ring-2', 'ring-green-300');
                }
            }

            playerScoreDisplay.textContent = gameState.score;
            
            // Wait for 2 seconds before moving to the next question
            setTimeout(() => {
                if (!gameState.isImpossible) {
                    gameState.currentQuestionIndex++;
                } else {
                    endGame(); // End game after impossible question
                    return;
                }
                loadQuestion();
            }, 2000);
        };

        const handleHelp = (helpType) => {
            if (gameState.score < 100) {
                showToast('لا توجد نقاط كافية لاستخدام هذه المساعدة', 'warning');
                return;
            }

            switch(helpType) {
                case 'fifty-fifty':
                    if (gameState.usedFiftyFifty) {
                         showToast('تم استخدام 50:50 بالفعل', 'warning');
                         return;
                    }
                    gameState.usedFiftyFifty = true;
                    gameState.score -= 100;
                    showToast('تم استخدام 50:50 -100 نقطة', 'info');
                    // Logic to remove two wrong answers
                    const questionData = gameState.questions[gameState.currentQuestionIndex];
                    const answerBtns = Array.from(document.querySelectorAll('.answer-btn'));
                    const wrongAnswers = answerBtns.filter(btn => btn.textContent !== questionData.answer);
                    shuffleArray(wrongAnswers);
                    wrongAnswers.slice(0, 2).forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'line-through');
                    });
                    document.querySelector(`button[data-help="fifty-fifty"]`).disabled = true;
                    break;
                case 'freeze':
                    if (gameState.usedFreeze) {
                        showToast('تم استخدام تجميد الوقت بالفعل', 'warning');
                        return;
                    }
                    gameState.usedFreeze = true;
                    gameState.score -= 100;
                    showToast('تم استخدام تجميد الوقت -100 نقطة', 'info');
                    stopTimer();
                    setTimeout(() => startTimer(), 10000);
                    document.querySelector(`button[data-help="freeze"]`).disabled = true;
                    break;
                case 'swap':
                    if (gameState.usedSwap) {
                         showToast('تم استخدام تغيير السؤال بالفعل', 'warning');
                         return;
                    }
                    gameState.usedSwap = true;
                    gameState.score -= 100;
                    showToast('تم استخدام تغيير السؤال -100 نقطة', 'info');
                    const currentQuestion = gameState.questions[gameState.currentQuestionIndex];
                    const nextQuestion = gameState.questions[gameState.currentQuestionIndex + 1];
                    // Simple swap, could be more robust
                    gameState.questions[gameState.currentQuestionIndex] = nextQuestion;
                    gameState.questions[gameState.currentQuestionIndex + 1] = currentQuestion;
                    loadQuestion();
                    document.querySelector(`button[data-help="swap"]`).disabled = true;
                    break;
                case 'skip':
                    if (gameState.score < gameState.skipCost) {
                        showToast('لا توجد نقاط كافية للتخطي.', 'warning');
                        return;
                    }
                    gameState.score -= gameState.skipCost;
                    gameState.skips++;
                    gameState.skipCost += 50;
                    skipCostDisplay.textContent = gameState.skipCost;
                    skipCountDisplay.textContent = gameState.skips;
                    showToast(`تم تخطي السؤال -${gameState.skipCost - 50} نقطة`, 'info');
                    gameState.wrongAnswers++; // Treat as a wrong answer for summary purposes
                    gameState.currentQuestionIndex++;
                    loadQuestion();
                    break;
            }
            playerScoreDisplay.textContent = gameState.score;
        };
        
        const endGame = () => {
            stopTimer();
            gameState.endTime = new Date();
            gameState.duration = Math.floor((gameState.endTime - gameState.startTime) / 1000);
            
            // Update results screen
            finalName.textContent = gameState.playerName;
            finalScore.textContent = gameState.score;
            finalDuration.textContent = `${Math.floor(gameState.duration / 60)} دقيقة و ${gameState.duration % 60} ثواني`;
            finalCorrect.textContent = gameState.correctAnswers;
            finalWrong.textContent = gameState.wrongAnswers;
            finalSkips.textContent = gameState.skips;
            
            if (gameState.impossibleUsed) {
                if (gameState.impossibleCorrect) {
                    finalImpossible.textContent = 'إجابة صحيحة';
                } else {
                    finalImpossible.textContent = 'إجابة خاطئة';
                }
            } else {
                finalImpossible.textContent = 'لم يُستخدم';
            }
            
            const totalQuestionsAnswered = gameState.correctAnswers + gameState.wrongAnswers;
            const percentage = totalQuestionsAnswered > 0 ? (gameState.correctAnswers / totalQuestionsAnswered) * 100 : 0;
            const performance = getPerformanceLevel(percentage, 100);
            
            performanceText.textContent = performance.level;
            performanceBar.style.width = `${percentage}%`;
            performanceBar.style.backgroundColor = performance.color;
            
            // Prepare share links
            const shareText = `لقد حصلت على ${gameState.score} نقطة في مسابقة المعلومات! مستواي هو ${performance.level}.`;
            shareXBtn.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=http://yourwebsite.com`; // Add your website link
            shareInstagramBtn.href = `https://www.instagram.com/share?text=${encodeURIComponent(shareText)}`; // Note: Instagram sharing is tricky for web

            showScreen(resultsScreen);
            
            // Prepare data for Google Sheets
            const dataToSend = {
                deviceId: localStorage.getItem('deviceId') || `anon-${Date.now()}`,
                playerName: gameState.playerName,
                avatarId: gameState.avatarId,
                startTime: gameState.startTime.toISOString(),
                endTime: gameState.endTime.toISOString(),
                durationSeconds: gameState.duration,
                status: 'finished',
                numQuestions: QUIZ_QUESTIONS.length,
                correctAnswers: gameState.correctAnswers,
                wrongAnswers: gameState.wrongAnswers,
                skips: gameState.skips,
                usedFiftyFifty: gameState.usedFiftyFifty ? 1 : 0,
                usedFreeze: gameState.usedFreeze ? 1 : 0,
                usedSwap: gameState.usedSwap ? 1 : 0,
                impossibleUsed: gameState.impossibleUsed ? 1 : 0,
                impossibleCorrect: gameState.impossibleCorrect ? 1 : 0,
                scoreBeforeImpossible: gameState.score, // Simple for now
                finalScore: gameState.score,
                roundDifficulty: 'normal',
                userAgent: navigator.userAgent,
                // ip: '... (will be handled by server script)',
            };
            
            sendResultToGoogleSheets(dataToSend);
        };
        
        // Google Sheets Integration
        const sendResultToGoogleSheets = async (data) => {
            try {
                const res = await fetch(API_ENDPOINT, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                console.log("Google Script request sent. Response:", res);
                // The actual response can't be read due to no-cors mode, which is common for Apps Script.
            } catch (err) {
                console.error("Error sending to Apps Script:", err);
                showToast('خطأ في الاتصال بالخادم. سيتم حفظ البيانات محلياً.', 'error');
                // Save locally to resend later
                const localData = JSON.parse(localStorage.getItem('pendingData') || '[]');
                localData.push(data);
                localStorage.setItem('pendingData', JSON.stringify(localData));
            }
        };
        
        const fetchLeaderboard = async () => {
            leaderboardBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">جاري تحميل لوحة الصدارة...</td></tr>`;
            try {
                // Using a direct fetch for simplicity, though a dedicated endpoint is better
                const res = await fetch(`${API_ENDPOINT}?action=getLeaderboard`); 
                const data = await res.json();
                
                leaderboardBody.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach((entry, index) => {
                        const rank = index + 1;
                        const level = getPerformanceLevel(entry.finalScore, 1000).level; // Assuming max score is 1000 for demo
                        let rankIcon = '';
                        if (rank === 1) rankIcon = `<i class="fas fa-trophy text-[#FFD700]"></i>`;
                        if (rank === 2) rankIcon = `<i class="fas fa-trophy text-gray-400"></i>`;
                        if (rank === 3) rankIcon = `<i class="fas fa-trophy text-orange-400"></i>`;
                        
                        let impossibleStatus = '';
                        if (entry.impossibleCorrect === 1) {
                            impossibleStatus = `<span class="text-[#FFD700] font-bold">صحيح</span>`;
                        } else if (entry.impossibleUsed === 1) {
                            impossibleStatus = `<span class="text-[#E53935]">خاطئ</span>`;
                        } else {
                            impossibleStatus = `<span class="text-gray-400">لم يُستخدم</span>`;
                        }
                        
                        const row = `
                            <tr class="border-b border-gray-700">
                                <td class="py-2 px-1 md:px-4 flex items-center gap-2">${rankIcon} ${rank}</td>
                                <td class="py-2 px-1 md:px-4">${entry.playerName}</td>
                                <td class="py-2 px-1 md:px-4 hidden md:table-cell">${level}</td>
                                <td class="py-2 px-1 md:px-4">${entry.finalScore}</td>
                                <td class="py-2 px-1 md:px-4">${impossibleStatus}</td>
                            </tr>
                        `;
                        leaderboardBody.innerHTML += row;
                    });
                } else {
                    leaderboardBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">لا توجد بيانات متاحة.</td></tr>`;
                }
            } catch (err) {
                console.error("Error fetching leaderboard:", err);
                leaderboardBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-[#E53935]">خطأ في تحميل البيانات.</td></tr>`;
            }
        };

        // Event Listeners
        startBtn.addEventListener('click', () => {
            showScreen(avatarScreen);
        });
        
        leaderboardBtn.addEventListener('click', () => {
            showScreen(leaderboardScreen);
            fetchLeaderboard();
        });
        
        backFromLeaderboard.addEventListener('click', () => {
            showScreen(splashScreen);
        });

        // Generate avatars
        avatars.forEach((src, index) => {
            const container = document.createElement('div');
            container.className = 'w-24 h-24 md:w-32 md:h-32 p-1 rounded-full cursor-pointer transition-transform transform hover:scale-110 relative';
            container.dataset.avatarId = `avatar_${index + 1}`;
            
            const img = document.createElement('img');
            img.src = src;
            img.className = 'w-full h-full rounded-full border-4 border-transparent hover:border-[#4FC3F7] transition-colors duration-300';
            img.alt = `Avatar ${index + 1}`;
            
            container.appendChild(img);
            avatarGrid.appendChild(container);
            
            container.addEventListener('click', () => {
                document.querySelectorAll('#avatar-grid > div').forEach(div => {
                    div.classList.remove('ring-4', 'ring-[#FFD700]');
                });
                container.classList.add('ring-4', 'ring-[#FFD700]');
                gameState.avatarId = container.dataset.avatarId;
                nextToNameBtn.disabled = false;
                nextToNameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        });

        nextToNameBtn.addEventListener('click', () => {
            showModal(nameModal);
        });

        confirmNameBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name.length >= 3 && name.length <= 15) {
                gameState.playerName = name;
                hideModal(nameModal);
                startGame();
            } else {
                nameError.classList.remove('hidden');
            }
        });

        nameInput.addEventListener('input', () => {
            if (nameInput.value.trim().length >= 3 && nameInput.value.trim().length <= 15) {
                nameError.classList.add('hidden');
            } else {
                nameError.classList.remove('hidden');
            }
        });

        endQuizBtn.addEventListener('click', () => {
            showModal(endQuizModal);
        });

        confirmEndBtn.addEventListener('click', () => {
            hideModal(endQuizModal);
            endGame();
        });

        cancelEndBtn.addEventListener('click', () => {
            hideModal(endQuizModal);
        });

        impossibleBtn.addEventListener('click', () => {
            showModal(impossibleModal);
        });

        acceptImpossibleBtn.addEventListener('click', () => {
            hideModal(impossibleModal);
            gameState.scoreBeforeImpossible = gameState.score;
            loadImpossibleQuestion();
        });
        
        declineImpossibleBtn.addEventListener('click', () => {
            hideModal(impossibleModal);
            endGame();
        });
        
        playAgainBtn.addEventListener('click', () => {
            showScreen(avatarScreen);
        });
        
        backToStartBtn.addEventListener('click', () => {
            showScreen(splashScreen);
        });

        helpBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const helpType = e.currentTarget.dataset.help;
                handleHelp(helpType);
            });
        });

        themeToggleBtn.addEventListener('click', () => {
            const body = document.body;
            body.classList.toggle('light-mode');
            body.classList.toggle('dark-mode');
            const icon = themeToggleBtn.querySelector('i');
            if (body.classList.contains('light-mode')) {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            } else {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
        });

        // Initial setup on page load
        window.onload = () => {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = `anon-${crypto.randomUUID()}`;
                localStorage.setItem('deviceId', deviceId);
            }
            // Check for pending data to send
            const pendingData = JSON.parse(localStorage.getItem('pendingData') || '[]');
            if (pendingData.length > 0) {
                pendingData.forEach(data => {
                    sendResultToGoogleSheets(data);
                });
                localStorage.removeItem('pendingData');
            }
        };
    </script>
</body>
</html>
