<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üß† ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ | ÿßÿÆÿ™ÿ®ÿ± ŸÇÿØÿ±ÿßÿ™ŸÉ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Cropper.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js" defer></script>
    <style>
    :root {
        --color-dark-bg: #1a1a2e; --color-dark-primary: #16213e; --color-dark-secondary: #0f3460;
        --color-dark-accent: #e94560; --color-dark-text: #f0f0f0; --color-dark-border: #374151;
        --color-dark-gold: #ffd700; --color-dark-success: #10b981; --color-dark-error: #ef4444;
        --color-light-bg: #f8fafc; --color-light-primary: #ffffff; --color-light-secondary: #e2e8f0;
        --color-light-accent: #2563eb; --color-light-text: #1e293b; --color-light-border: #cbd5e1;
        --color-light-gold: #ca8a04; --color-light-success: #059669; --color-light-error: #dc2626;
        --color-white: #ffffff; --color-black: #000000;
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --font-family: 'Cairo', sans-serif;
        --font-size-base: 1rem; --font-size-lg: 1.125rem; --font-size-xl: 1.25rem; --font-size-2xl: 1.5rem;
        --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem; --space-6: 1.5rem; --space-8: 2rem;
        --radius-lg: 0.5rem; --radius-xl: 0.75rem; --radius-2xl: 1rem; --radius-full: 9999px;
        --transition-fast: 150ms ease; --transition-normal: 300ms ease;
        --level-easy: #10b981; --level-medium: #3b82f6; --level-hard: #f59e0b; --level-impossible: #ef4444;
    }
    body[data-theme='dark'] { --bg-color: var(--color-dark-bg); --primary-color: var(--color-dark-primary); --secondary-color: var(--color-dark-secondary); --accent-color: var(--color-dark-accent); --text-color: var(--color-dark-text); --border-color: var(--color-dark-border); --gold-color: var(--color-dark-gold); --success-color: var(--color-dark-success); --error-color: var(--color-dark-error); }
    body[data-theme='light'] { --bg-color: var(--color-light-bg); --primary-color: var(--color-light-primary); --secondary-color: var(--color-light-secondary); --accent-color: var(--color-light-accent); --text-color: var(--color-light-text); --border-color: var(--color-light-border); --gold-color: var(--color-light-gold); --success-color: var(--color-light-success); --error-color: var(--color-light-error); }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body { min-height: 100%; font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
    .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: var(--space-8) var(--space-4); opacity: 0; visibility: hidden; transform: scale(0.95); transition: opacity var(--transition-normal), transform var(--transition-normal); overflow-y: auto; z-index: 1; }
    .screen.screen--align-top { justify-content: flex-start; }
    .screen.active { opacity: 1; visibility: visible; transform: scale(1); z-index: 10; }
    .content-box { background-color: var(--primary-color); border-radius: var(--radius-2xl); padding: var(--space-6); width: 100%; max-width: 30rem; box-shadow: var(--shadow-xl); text-align: center; border: 1px solid var(--border-color); }
    .button-group { display: flex; flex-direction: column; gap: var(--space-4); margin-top: var(--space-6); }
    .btn-main { background-color: var(--gold-color); color: var(--color-black); padding: var(--space-3) var(--space-6); border-radius: var(--radius-lg); font-weight: 700; font-size: var(--font-size-lg); cursor: pointer; transition: all var(--transition-fast); border: 2px solid var(--gold-color); box-shadow: var(--shadow-md); }
    .btn-main:hover:not(:disabled) { background-color: transparent; color: var(--gold-color); transform: translateY(-3px); box-shadow: var(--shadow-lg); }
    .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); padding: var(--space-3) var(--space-6); border-radius: var(--radius-lg); font-weight: 700; font-size: var(--font-size-lg); cursor: pointer; transition: all var(--transition-fast); border: 2px solid var(--border-color); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--accent-color); border-color: var(--accent-color); color: var(--color-white); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
    .avatar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6); }
    .avatar-option { width: 80%; aspect-ratio: 1/1; border-radius: var(--radius-full); object-fit: cover; cursor: pointer; border: 3px solid transparent; transition: all var(--transition-fast); }
    .avatar-option:hover { transform: scale(1.05); } .avatar-option.selected { border-color: var(--gold-color); transform: scale(1.1); }
    .avatar-upload-container { display: flex; justify-content: center; align-items: center; width: 80%; aspect-ratio: 1/1; border-radius: var(--radius-full); border: 3px dashed var(--border-color); cursor: pointer; transition: all var(--transition-fast); }
    .avatar-upload-container:hover { border-color: var(--gold-color); background-color: var(--secondary-color); } .avatar-upload-label { font-size: 2rem; color: var(--text-color); cursor: pointer; }
    #gameContainer { justify-content: flex-start; padding: var(--space-4); width: 100%; max-width: 900px; }
    .options-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-4); }
    .final-stats p { margin-bottom: var(--space-3); font-size: var(--font-size-lg); }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all var(--transition-normal); }
    .modal.active { opacity: 1; visibility: visible; }
    .modal-content { background-color: var(--primary-color); border-radius: var(--radius-2xl); padding: var(--space-6); width: 90%; max-width: 30rem; text-align: center; box-shadow: var(--shadow-xl); }
    .modal-buttons { display: flex; gap: var(--space-4); justify-content: center; margin-top: var(--space-6); }
    .toast-container { position: fixed; top: var(--space-4); left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: var(--space-3); pointer-events: none; }
    .toast { padding: var(--space-3); border-radius: var(--radius-lg); color: var(--color-white); box-shadow: var(--shadow-lg); animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; }
    .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--error-color); } .toast.info { background-color: var(--level-medium); }
    @keyframes toastIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
    .spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--secondary-color); border-top: 4px solid var(--gold-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .report-fab { position: fixed; bottom: var(--space-4); left: var(--space-4); width: 3.5rem; height: 3.5rem; background-color: var(--accent-color); color: var(--color-white); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; box-shadow: var(--shadow-lg); cursor: pointer; z-index: 999; transition: transform var(--transition-fast); display: none; }
    .report-fab:hover { transform: scale(1.1); } .report-fab.has-error { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(233, 69, 96, 0); } 100% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0); } }
    .cropper-container-modal { max-height: 70vh; }
    @media (min-width: 768px) { .button-group { flex-direction: row; justify-content: center; } .options-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body data-theme="dark" aria-live="polite" data-level="easy">
    <div id="toast-container" class="toast-container" aria-live="assertive"></div>
    <div id="reportFab" class="report-fab" role="button" aria-label="ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫ ÿπŸÜ ŸÖÿ¥ŸÉŸÑÿ©">‚ö†Ô∏è</div>
    <div id="loader" class="screen active" role="status" aria-label="ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ"><div class="spinner" aria-hidden="true"></div></div>

    <div id="startScreen" class="screen" aria-hidden="true">
        <div class="content-box">
            <h2>üß† ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™</h2><p>ÿßÿÆÿ™ÿ®ÿ± ŸÇÿØÿ±ÿßÿ™ŸÉ ŸÅŸä ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿ™ŸÅÿßÿπŸÑŸäÿ© ÿ¥ŸäŸÇÿ©</p>
            <div class="button-group">
                <button id="startPlayBtn" class="btn-main">ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®</button>
                <button id="showLeaderboardBtn" class="btn-secondary">ŸÑŸàÿ≠ÿ© ÿßŸÑÿµÿØÿßÿ±ÿ©</button>
            </div>
        </div>
    </div>
    <div id="avatarScreen" class="screen" aria-hidden="true">
        <div class="content-box">
            <h2>ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ™ŸÉ ÿßŸÑÿ±ŸÖÿ≤Ÿäÿ©</h2>
            <div class="avatar-grid" role="group"></div>
            <div class="button-group">
                <button id="confirmAvatarBtn" class="btn-main" disabled>ÿßŸÑÿ™ÿßŸÑŸä</button>
            </div>
        </div>
    </div>
    <div id="nameEntry" class="screen" aria-hidden="true">
        <div class="content-box">
            <h2>ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ</h2>
            <input type="text" id="nameInput" placeholder="ŸÖÿ´ŸÑÿß: ÿπÿ®ÿØ ÿßŸÑŸÑŸá" maxlength="25">
            <div id="nameError" style="color:var(--error-color); display:none; margin-top:0.5rem;"></div>
            <div class="button-group">
                <button id="confirmNameBtn" class="btn-main">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ•ÿ≥ŸÖ</button>
            </div>
        </div>
    </div>
    <div id="instructionsScreen" class="screen screen--align-top" aria-hidden="true">
        <div class="content-box">
            <h2>üìã ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©</h2>
            <div style="text-align:right; margin:1.5rem 0;">
                <p><strong>‚öñÔ∏è ÿßŸÑŸÜŸÇÿßÿ∑:</strong> ÿµÿ≠Ÿäÿ≠ÿ©: +100 / ÿÆÿßÿ∑ÿ¶ÿ©: -100</p>
                <p><strong>‚è±Ô∏è ÿßŸÑŸàŸÇÿ™:</strong> ŸÑŸÉŸÑ ÿ≥ÿ§ÿßŸÑ ŸàŸÇÿ™ ŸÖÿ≠ÿØÿØ</p>
                <p><strong>üõ†Ô∏è ÿßŸÑŸÖÿ≥ÿßÿπÿØÿßÿ™:</strong> ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©: -100 / ÿßŸÑÿ™ÿÆÿ∑Ÿä: -20 (Ÿàÿ™ÿ™ÿ≤ÿßŸäÿØ)</p>
                <p><strong>üéØ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™:</strong> ÿ≥ŸáŸÑ / ŸÖÿ™Ÿàÿ≥ÿ∑ / ÿµÿπÿ® / ŸÖÿ≥ÿ™ÿ≠ŸäŸÑ</p>
                <p><strong>üö´ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°:</strong> ŸÖÿ≥ŸÖŸàÿ≠ 3 ŸÅŸÇÿ∑</p>
                <p><strong>üì© ÿßŸÑÿØÿπŸÖ:</strong> ÿ™ŸàÿßÿµŸÑ ÿπÿ®ÿ± <a href="https://x.com/_MS_AbuQusay" target="_blank">ÿ•ŸÉÿ≥</a> ÿ£Ÿà <a href="https://www.instagram.com/_ms_abuqusay" target="_blank">ÿ•ŸÜÿ≥ÿ™ÿ∫ÿ±ÿßŸÖ</a></p>
            </div>
            <div class="button-group">
                <button id="instructionsConfirmBtn" class="btn-main">ÿ≠ÿ≥ŸÜÿßŸãÿå ŸÅŸáŸÖÿ™</button>
            </div>
        </div>
    </div>
    
    <main id="gameContainer" class="screen" aria-hidden="true"></main>
    
    <div id="endScreen" class="screen screen--align-top" aria-hidden="true">
        <div class="content-box">
            <h2>üèÜ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©</h2>
            <div class="final-stats" style="text-align:right;">
                <p>‚úçÔ∏è ÿßŸÑÿßÿ≥ŸÖ: <strong id="finalName"></strong></p>
                <p>üÜî ÿßŸÑŸÖÿπÿ±ŸëŸÅ: <strong id="finalId"></strong></p>
                <p>‚úÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: <strong id="finalCorrect"></strong></p>
                <p>‚ùå ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿÆÿßÿ∑ÿ¶ÿ©: <strong id="finalWrong"></strong></p>
                <p>‚è≠Ô∏è ŸÖÿ±ÿßÿ™ ÿßŸÑÿ™ÿÆÿ∑Ÿä: <strong id="finalSkips"></strong></p>
                <p>‚≠ê ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©: <strong id="finalScore"></strong></p>
                <p>‚è±Ô∏è ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ: <strong id="totalTime"></strong></p>
                <p>üìà ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ: <strong id="finalLevel"></strong></p>
                <p>üéØ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿØŸÇÿ©: <strong id="finalAccuracy"></strong></p>
                <p>‚è≥ ŸÖÿ™Ÿàÿ≥ÿ∑ ŸàŸÇÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©: <strong id="finalAvgTime"></strong></p>
                <div><span>ÿ£ÿØÿßÿ§ŸÉ: </span><strong id="performanceText"></strong></div>
            </div>
            <div class="button-group">
                <button id="playAgainBtn" class="btn-main">ŸÑÿπÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</button>
                <button id="statsBtn" class="btn-secondary">ŸÑŸàÿ≠ÿ© ÿßŸÑÿµÿØÿßÿ±ÿ©</button>
            </div>
        </div>
    </div>
    <div id="leaderboardScreen" class="screen screen--align-top" aria-hidden="true">
        <div class="content-box">
            <h2>üèÜ ŸÑŸàÿ≠ÿ© ÿßŸÑÿµÿØÿßÿ±ÿ©</h2>
            <div id="leaderboardContent"></div>
            <div class="button-group">
                <button id="backToStartBtn" class="btn-secondary">ÿßŸÑÿπŸàÿØÿ©</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmExitModal" class="modal" aria-hidden="true"><div class="modal-content"><h3>ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©ÿü</h3><p>ÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÜŸÇÿßÿ∑ŸÉ ÿßŸÑÿ≠ÿßŸÑŸäÿ©.</p><div class="modal-buttons"><button id="confirmExitYes" class="btn-main">ŸÜÿπŸÖ</button><button id="confirmExitNo" class="btn-secondary">ŸÑÿß</button></div></div></div>
    <div id="reportErrorModal" class="modal" aria-hidden="true"><div class="modal-content"><h3>ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫ ÿπŸÜ ŸÖÿ¥ŸÉŸÑÿ©</h3><p id="reportErrorText"></p><div class="modal-buttons"><button id="reportErrorYes" class="btn-main">ÿ•ÿ±ÿ≥ÿßŸÑ</button><button id="reportErrorNo" class="btn-secondary">ÿ•ŸÑÿ∫ÿßÿ°</button></div></div></div>
    <div id="cropperModal" class="modal" aria-hidden="true"><div class="modal-content"><h2>ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©</h2><div class="cropper-container-modal"><img id="cropperImage" src=""></div><div class="modal-buttons"><button id="cropBtn" class="btn-main">ŸÇÿµ</button><button id="cancelCropBtn" class="btn-secondary">ÿ•ŸÑÿ∫ÿßÿ°</button></div></div></div>

<script>
class QuizGame {
    constructor() {
        this.API_URL = "https://script.google.com/macros/s/AKfycbwSieydP8pgaTKpqzlDBYDEjeuMSYu85eVLwUlMepwkbGOi4toI5-Lc-lpeK8T6rRdg/exec";
        this.API_KEY = "AbuQusay2025_SecretKey";
        this.QUESTION_TIME = 80; this.MAX_WRONG_ANSWERS = 3; this.STARTING_SCORE = 100;
        this.LEVELS = [ { name: "easy", label: "ÿ≥ŸáŸÑ" }, { name: "medium", label: "ŸÖÿ™Ÿàÿ≥ÿ∑" }, { name: "hard", label: "ÿµÿπÿ®" }, { name: "impossible", label: "ŸÖÿ≥ÿ™ÿ≠ŸäŸÑ" } ];
        this.QUESTIONS = {}; this.HELPER_COSTS = { fiftyFifty: 100, freezeTime: 100 };
        this.initialSkipCost = 20; this.currentSkipCost = this.initialSkipCost;
        this.gameState = {}; this.lastError = null; this.lastFocusedElement = null; this.cropper = null;
        this.init();
    }

    async init() {
        this.catchGlobalErrors(); this.cacheDomElements(); this.bindEventListeners();
        const q = await this.loadQuestions();
        if (q) {
            this.populateAvatarGrid();
            this.showScreen('start');
            this.domElements.screens.loader.style.display = 'none';
        } else {
            // Handle error loading questions
        }
    }

    cacheDomElements() {
        this.domElements = {
            screens: { loader: document.getElementById('loader'), start: document.getElementById('startScreen'), avatar: document.getElementById('avatarScreen'), nameEntry: document.getElementById('nameEntry'), instructions: document.getElementById('instructionsScreen'), game: document.getElementById('gameContainer'), end: document.getElementById('endScreen'), leaderboard: document.getElementById('leaderboardScreen') },
            avatarGrid: document.querySelector('.avatar-grid'),
            confirmAvatarBtn: document.getElementById('confirmAvatarBtn'),
            nameInput: document.getElementById('nameInput'),
            nameError: document.getElementById('nameError'),
            reportFab: document.getElementById('reportFab'),
            reportErrorModal: document.getElementById('reportErrorModal'),
            reportErrorText: document.getElementById('reportErrorText'),
            confirmExitModal: document.getElementById('confirmExitModal'),
            cropperModal: document.getElementById('cropperModal'),
            cropperImage: document.getElementById('cropperImage')
        };
    }

    bindEventListeners() {
        document.getElementById('startPlayBtn').addEventListener('click', () => this.showScreen('avatar'));
        this.domElements.confirmAvatarBtn.addEventListener('click', () => this.showScreen('nameEntry'));
        document.getElementById('confirmNameBtn').addEventListener('click', () => this.startGame());
        document.getElementById('instructionsConfirmBtn').addEventListener('click', () => this.showScreen('game'));
        document.getElementById('showLeaderboardBtn').addEventListener('click', () => this.displayLeaderboard());
        document.getElementById('backToStartBtn').addEventListener('click', () => this.showScreen('start'));
        document.getElementById('confirmExitYes').addEventListener('click', () => this.endGame());
        document.getElementById('confirmExitNo').addEventListener('click', () => this.hideModal(this.domElements.confirmExitModal));
        document.getElementById('playAgainBtn').addEventListener('click', () => this.resetGame());
        document.getElementById('statsBtn').addEventListener('click', () => this.displayLeaderboard());
        this.domElements.reportFab.addEventListener('click', () => this.showReportModal());
        document.getElementById('reportErrorYes').addEventListener('click', () => this.sendErrorReport());
        document.getElementById('reportErrorNo').addEventListener('click', () => this.hideModal(this.domElements.reportErrorModal));
        document.getElementById('cropBtn').addEventListener('click', () => this.cropAndSetAvatar());
        document.getElementById('cancelCropBtn').addEventListener('click', () => this.hideModal(this.domElements.cropperModal));
        document.body.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'endQuizBtn') {
                this.showModal(this.domElements.confirmExitModal);
            }
        });
    }

    populateAvatarGrid() {
        this.domElements.avatarGrid.innerHTML = '';
        const u = document.createElement('div');
        u.className = 'avatar-upload-container';
        u.innerHTML = `<label for="avatarUploadInput" class="avatar-upload-label" title="ÿ±ŸÅÿπ ÿµŸàÿ±ÿ©">‚ûï</label><input type="file" id="avatarUploadInput" accept="image/*" style="display:none;">`;
        this.domElements.avatarGrid.appendChild(u);
        document.getElementById('avatarUploadInput').addEventListener('change', (e) => this.handleAvatarUpload(e));
        const a = [ "https://em-content.zobj.net/thumbs/120/apple/354/woman_1f469.png", "https://em-content.zobj.net/thumbs/120/apple/354/man_1f468.png", "https://em-content.zobj.net/thumbs/120/apple/354/person-beard_1f9d4.png" ];
        a.forEach((url, i) => { const img = document.createElement('img'); img.src = url; img.classList.add('avatar-option'); img.addEventListener('click', () => this.selectAvatar(img)); this.domElements.avatarGrid.appendChild(img); });
    }
    
    selectAvatar(i) {
        this.domElements.avatarGrid.querySelectorAll('.avatar-option.selected').forEach(e => e.classList.remove('selected'));
        i.classList.add('selected'); this.gameState.avatar = i.src; this.domElements.confirmAvatarBtn.disabled = false;
    }

    handleAvatarUpload(e) {
        const f = e.target.files[0];
        if (!f || !f.type.startsWith('image/') || f.size > 2 * 1024 * 1024) { this.showToast('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿµŸàÿ±ÿ© ÿµÿßŸÑÿ≠ (ÿ£ŸÇŸÑ ŸÖŸÜ 2 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™).', 'error'); return; }
        const reader = new FileReader();
        reader.onload = (ev) => {
            this.domElements.cropperImage.src = ev.target.result;
            this.showModal(this.domElements.cropperModal);
            if (this.cropper) this.cropper.destroy();
            this.cropper = new Cropper(this.domElements.cropperImage, { aspectRatio: 1, viewMode: 1, background: false, modal: false });
        };
        reader.readAsDataURL(f);
    }
    
    cropAndSetAvatar() {
        if (!this.cropper) return;
        const canvas = this.cropper.getCroppedCanvas({ width: 128, height: 128 });
        const dataUrl = canvas.toDataURL();
        let customAvatar = document.getElementById('customAvatar');
        if (!customAvatar) {
            customAvatar = document.createElement('img'); customAvatar.id = 'customAvatar'; customAvatar.classList.add('avatar-option');
            customAvatar.addEventListener('click', () => this.selectAvatar(customAvatar));
            this.domElements.avatarGrid.insertBefore(customAvatar, this.domElements.avatarGrid.children[1]);
        }
        customAvatar.src = dataUrl;
        this.selectAvatar(customAvatar);
        this.hideModal(this.domElements.cropperModal);
    }

    catchGlobalErrors() { window.onerror = (m, s, l, c, e) => { this.lastError = { message: m, source: s, lineno: l, error: e ? e.stack : 'N/A' }; this.domElements.reportFab.style.display = 'flex'; return true; }; }
    showReportModal() { this.domElements.reportErrorText.innerHTML = this.lastError ? `ÿßŸÉÿ™ÿ¥ŸÅŸÜÿß ÿÆÿ∑ÿ£: <br><small>${this.lastError.message}</small>` : "ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸÑÿßÿ∫ ÿπÿßŸÖÿü"; this.showModal(this.domElements.reportErrorModal); }
    async sendErrorReport() { /* ... implementation ... */ }
    
    async startGame() {
        const name = this.domElements.nameInput.value.trim();
        if (name.length < 3) {
            this.domElements.nameError.textContent = "ÿßŸÑÿßÿ≥ŸÖ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 3 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ."; this.domElements.nameError.style.display = 'block'; return;
        }
        this.domElements.nameError.style.display = 'none';
        this.gameState = { name, avatar: this.gameState.avatar, playerId: this.generatePlayerId(), deviceId: this.generateDeviceId(), level: 0, wrongAnswers: 0, correctAnswers: 0, skips: 0, startTime: new Date(), helpersUsed: { fiftyFifty: false, freezeTime: false } };
        this.showScreen('instructions');
    }
    
    updateUI() {
        const isImpossible = this.gameState.level !== undefined && this.LEVELS[this.gameState.level].name === 'impossible';
        // Simplified
    }
    
    endGame() {
        const isCompleted = this.gameState.level >= this.LEVELS.length - 1;
        const resultsData = { /* placeholder */ isGameCompleted: isCompleted };
        this.saveResults(resultsData);
        this.showScreen('end');
    }

    async displayLeaderboard() {
        this.showScreen('leaderboard');
        const contentDiv = document.getElementById('leaderboardContent');
        contentDiv.innerHTML = '<div class="spinner"></div>';
        try {
            const response = await this.apiCall({ action: 'getLeaderboard' });
            if (response.success && response.leaderboard) {
                let tableHTML = 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿµÿØÿßÿ±ÿ© ŸÅÿßÿ±ÿ∫ÿ©!';
                if (response.leaderboard.length > 0) {
                    tableHTML = `<table style="width:100%;text-align:right;"><thead><tr><th>ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®</th><th>ÿßŸÑÿßÿ≥ŸÖ</th><th>ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</th><th>ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</th></tr></thead><tbody>`;
                    response.leaderboard.forEach(row => {
                        tableHTML += `<tr><td>${row.rank}</td><td>${row.name}</td><td>${row.level}</td><td>${row.attempt}</td></tr>`;
                    });
                    tableHTML += `</tbody></table>`;
                }
                contentDiv.innerHTML = tableHTML;
            } else { contentDiv.innerHTML = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£.'; }
        } catch (error) { contentDiv.innerHTML = 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ.'; }
    }
    
    async loadQuestions() { return true; } generatePlayerId() { return 'PID' } generateDeviceId() { return 'DID' }
    showScreen(s) { if(!this.domElements.screens[s]) return; Object.values(this.domElements.screens).forEach(e => e.style.display = 'none'); this.domElements.screens[s].style.display = 'flex'; }
    showModal(m) { this.lastFocusedElement = document.activeElement; m.classList.add('active'); m.setAttribute('aria-hidden', 'false'); if(m.querySelector('button')) m.querySelector('button').focus(); }
    hideModal(m) { m.classList.remove('active'); m.setAttribute('aria-hidden', 'true'); if (this.lastFocusedElement) this.lastFocusedElement.focus(); }
    showToast(m,t){ console.log(`Toast [${t}]: ${m}`); } async apiCall(p) { console.log('API Call:', p); return { success: true, leaderboard: [{rank:'üéñÔ∏è', name:'ÿ£ÿ®Ÿà ŸÇÿµŸä', level:'ŸÖÿ≥ÿ™ÿ≠ŸäŸÑ', attempt:1}] }; }
    resetGame() { this.showScreen('start'); }
    saveResults(r) { console.log("Saving results:", r); }
}

document.addEventListener('DOMContentLoaded', () => new QuizGame());
</script>
</body>
</html>

